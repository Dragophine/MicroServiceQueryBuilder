<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">App/alerting/alerting.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">App/alerting/alerting.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

angular.module(&apos;queryBuilder.alerting&apos;, [&apos;ngRoute&apos;, &apos;queryBuilder.services&apos;])

.config([&apos;$routeProvider&apos;, function($routeProvider) {
  $routeProvider.when(&apos;/alerting&apos;, {
    templateUrl: &apos;alerting/alerting.html&apos;
  });
}])
/**
   * This controller handles the main operation in the user interface.
   * It configures and handle all actions in the alert view.
   * 
   * @version 1.0.0
   */
.controller(&apos;alertingCtrl&apos;, [&apos;$requests&apos;,
	function($requests) {
	var self = this;
	
    /**
     * Holds name from alert.
     * @type {string}
     */
	self.name = &quot;&quot;;
    /**
     * Holds type from alert. Examples: int, string,...
     * @type {string}
     */
	self.type = &quot;&quot;;
    /**
     * Holds filter type from alert. Examples: in, like,...
     * @type {string}
     */
	self.filterType = &quot;&quot;;
    /**
     * Holds email address from alert.
     * @type {string}
     */
	self.email = &quot;&quot;;
    /**
     * Holds limit value from alert.
     * @type {string}
     */
	self.value = &quot;&quot;;
    /**
     * If a value from alert is missing or invalid in save dialog a message will be stored
     * in this array.
     * @type {array}
     */
	self.text = [];
    /**
     * Store the name from loaded alert. When an alert has been loaded, you have the option
     * to create a new alert when saving or to rewrite the loaded alert.
     * @type {string}
     */
	self.selectedAlertName = &quot;&quot;;
    /**
     * Store all queries which can be selected in alert view.
     * @type {array}
     */
	self.queries = [];
    /**
     * Holds selected query from alert.
     * @type {string}
     */
	self.selectedQuery = &quot;&quot;;	
	/**
	 * Modal dialog for missing or invalid data.
     * @type {object}
	 */
	var missingDataModal = document.getElementById(&apos;myModalMissingData&apos;);
	/**
	 * Ok-button from modal dialog for missing or invalid data.
     * @type {object}
	 */
	var missingDataOkButton = document.getElementById(&quot;missingDataOk&quot;);
	
	/**
	 * Close modal dialog if user select the ok-button in dialog.
	 */
	missingDataOkButton.onclick = function() {
		missingDataModal.style.display = &quot;none&quot;;
	}
	
	 /**
     * Holds the error string which is displayed to the user.
     * The table is only shown when the hasError property is set to TRUE.
     * @type {string}
     */
	self.error = &quot;&quot;;
	
	 /**
     * If there was an error during the execution of the query this is set to 
     * true and the error will be displayed. Otherwise the table will be displayed.
     * @type {boolean}
     */
	self.hasError = false;
	
	/**
	 * Callback from delete/save alert call. If query was successful refresh alert names.
	 * Otherwise print error.
	 *
	 * @param {boolean} $success - true when there are no errors.
	 * @param {Object} $data - the requested data.
     * @param {number} $status - the actual server status.
	 */
	self.callback = function($success, $data, $status) {
		self.hasError = !$success;
		if($success)
		{
			$requests.getAllAlertNames(self.getAlertsCB);
		}
		else
		{
			self.error = $data;
		}
	}
	
	/**
	 * Callback from get all nodes call. If query was successful save data in variable self.queries.
	 * Otherwise print error.
	 * 
	 * @param {boolean} $success - true when there are no errors.
	 * @param {Object} $data - the requested data (In this case the queries).
     * @param {number} $status - the actual server status.
	 */
	self.queriesCB = function($success, $data, $status){
		self.hasError = !$success;
		if($success)
		{
			self.queries = $data;
		}
		else
		{
			self.error = $data;
		}
	}
	$requests.loadAllQueries(self.queriesCB);
	
	/**
	 * Callback from get query by name call. If query was successful save data in variable self.selectedQuery.
	 * Otherwise print error.
	 * 
	 * @param {boolean} $success - true when there are no errors.
	 * @param {Object} $data - the requested data (In this case the query).
     * @param {number} $status - the actual server status.
	 */
	self.getQueryByNameCB = function($success, $data, $status){
		self.hasError = !$success;
		if($success){
			self.selectedQuery = $data.name;
		}
		else
		{
			self.error = $data;
		}
	}
	
	/**
	 * Callback from get all alert names call. If query was successful save data in variable self.existingAlerts.
	 * Otherwise print error.
	 * 
	 * @param {boolean} $success - true when there are no errors.
	 * @param {Object} $data - the requested data (In this case the alert names).
     * @param {number} $status - the actual server status.
	 */
	self.getAlertsCB = function($success, $data, $status) {
		self.hasError = !$success;
		if($success){
			self.existingAlerts = $data;
		}
		else
		{
			self.error = $data;
		}
	}	
	$requests.getAllAlertNames(self.getAlertsCB);
	
	/**
	 * Create new alert, if all fields are filled correctly.
	 */
    self.addAlert = function () {
    	checkAllFieldsValidate(true);
        if(self.text != &quot;&quot;){
            missingDataModal.style.display = &quot;block&quot;;
        }
        else
		{
			$requests.addAlert(self.name, self.selectedQuery, self.type, self.filterType,
			self.email, self.value, self.getAlertsCB);
			$requests.getAllAlertNames(self.getAlertsCB);
			self.resetValues();
        }
    };
    
	/**
	 * Save already existing alert, if all fields are filled correctly.
	 */
    self.saveAlert = function () {
    	checkAllFieldsValidate(false);
        if(self.text != &quot;&quot;){
            missingDataModal.style.display = &quot;block&quot;;
        }
        else
		{
			$requests.saveAlert(self.selectedAlertName, self.name, self.selectedQuery, self.type, self.filterType,
			self.email, self.value, self.callback);
        }
    };
	
	/**
	 * Check if email address is correct.
	 * 
	 * @param {string} email - email address from alert form.
	 */
	function validateEmail(email) {
		var re =  /^(([^&lt;&gt;()[\]\.,;:\s@\&quot;]+(\.[^&lt;&gt;()[\]\.,;:\s@\&quot;]+)*)|(\&quot;.+\&quot;))@(([^&lt;&gt;()[\]\.,;:\s@\&quot;]+\.)+[^&lt;&gt;()[\]\.,;:\s@\&quot;]{2,})$/i;
		return re.test(email);
	}
	
	/**
	 * Check if the name from alert form already exists.
	 */
	function existsNameAlready() {
		$requests.getAllAlertNames(self.getAlertsCB);
		
		for (var i = 0; i &lt; self.existingAlerts.length; i++)
	    {
	        if (self.existingAlerts[i].name === self.name)
	        {
	            return true;
	        }
	    }
	    return false;		
	}
	
	/**
	 * Check if all fields in alert form are correctly filled.
	 * 
	 * @param {boolean} $checkIfNameExists - Is it necessary to check the name.
	 */
	function checkAllFieldsValidate($checkIfNameExists) {
    	self.text = [];
		if($checkIfNameExists &amp;&amp; (self.name === null || self.name === &quot;&quot;))
		{
            self.text.push(&quot;Bitte geben Sie einen Namen ein.&quot;);
        }
		else if($checkIfNameExists &amp;&amp; existsNameAlready())
		{
			self.text.push(&quot;Der angegebene Name existiert bereits, geben Sie bitte einen anderen Namen an.&quot;);
		}
        if(self.selectedQuery === null || self.selectedQuery === &quot;&quot;){
            self.text.push(&quot;Bitte w&#xE4;hlen Sie eine g&#xFC;ltige Query aus.&quot;);
        }
        if(!validateEmail(self.email)){
            self.text.push(&quot;Bitte geben Sie eine korrekte Email Adresse ein.&quot;);
        }
        if(self.type === null || self.type === &quot;&quot;){
            self.text.push(&quot;Bitte geben Sie einen Datentyp ein.&quot;);
        }
        if(self.filterType === null || self.filterType === &quot;&quot;){
            self.text.push(&quot;Bitte geben Sie einen Filtertyp ein.&quot;);
        }
        if(self.value === null || self.value === &quot;&quot;){
            self.text.push(&quot;Bitte geben Sie einen g&#xFC;ltigen Wert ein.&quot;);
        }
	}
	
	/**
	 * Load selected alert.
	 * 
	 * @param {Object} $query - Load this query.
	 */
	self.selectLoad = function($query) {
		$requests.getQueryByName($query.query, self.getQueryByNameCB);
		self.name = $query.name;
		self.type = $query.type;
		self.filterType = $query.filterType;
		self.email = $query.email;
		self.value = $query.value;		
		self.selectedAlertName = self.name;
	}
	
	/**
	 * Delete selected alert.
	 * 
	 * @param {Object} $query - Delete this query.
	 */
	self.selectDelete = function($query) {		
		$requests.deleteAlert($query.name, self.callback);
	}

	/**
	 * Reset all values in alert form.
	 */
	self.resetValues = function() {		
		self.name = &quot;&quot;;
		self.type = &quot;&quot;;
		self.filterType = &quot;&quot;;
		self.email = &quot;&quot;;
		self.value = &quot;&quot;;
		self.selectedQuery = &quot;&quot;;		
		self.selectedAlertName = &quot;&quot;;
	}
}]);</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
