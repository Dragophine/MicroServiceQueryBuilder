<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../">
  <title data-ice="title">App/expertMode/codemirror-5.20.2/test/test.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">expertMode/codemirror-5.20.2/src</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-copyState">copyState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-defineMIME">defineMIME</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-defineMode">defineMode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extendMode">extendMode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getMode">getMode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-innerMode">innerMode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resolveMode">resolveMode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-startState">startState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-modeExtensions">modeExtensions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-modes">modes</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">expertMode/codemirror-5.20.2/src/display</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Display">Display</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-delayBlurEvent">delayBlurEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ensureFocus">ensureFocus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onBlur">onBlur</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onFocus">onFocus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setGuttersForLineNumbers">setGuttersForLineNumbers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateGutters">updateGutters</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-startWorker">startWorker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-alignHorizontally">alignHorizontally</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-maybeUpdateLineNumberWidth">maybeUpdateLineNumberWidth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadMode">loadMode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resetModeState">resetModeState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-docMethodOp">docMethodOp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-endOperation">endOperation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-methodOp">methodOp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-operation">operation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-runInOp">runInOp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-startOperation">startOperation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onScrollWheel">onScrollWheel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setScrollLeft">setScrollLeft</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setScrollTop">setScrollTop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-wheelEventPixels">wheelEventPixels</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-initScrollbars">initScrollbars</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-measureForScrollbars">measureForScrollbars</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateScrollbars">updateScrollbars</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addToScrollPos">addToScrollPos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-calculateScrollPos">calculateScrollPos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ensureCursorVisible">ensureCursorVisible</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-maybeScrollWindow">maybeScrollWindow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resolveScrollToPos">resolveScrollToPos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-scrollIntoView">scrollIntoView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-scrollPosIntoView">scrollPosIntoView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-drawSelectionCursor">drawSelectionCursor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-prepareSelection">prepareSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-restartBlink">restartBlink</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateSelection">updateSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-DisplayUpdate">DisplayUpdate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-maybeClipScrollbars">maybeClipScrollbars</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-postUpdateDisplay">postUpdateDisplay</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setDocumentHeight">setDocumentHeight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateDisplayIfNeeded">updateDisplayIfNeeded</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateDisplaySimple">updateDisplaySimple</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateGutterSpace">updateGutterSpace</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildLineElement">buildLineElement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateLineForChanges">updateLineForChanges</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateHeightsInViewport">updateHeightsInViewport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-visibleLines">visibleLines</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-adjustView">adjustView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-countDirtyView">countDirtyView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-regChange">regChange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-regLineChange">regLineChange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resetView">resetView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-scrollbarModel">scrollbarModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">expertMode/codemirror-5.20.2/src/edit</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CodeMirror">CodeMirror</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deleteNearSelection">deleteNearSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clearDragCursor">clearDragCursor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onDragOver">onDragOver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onDragStart">onDragStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onDrop">onDrop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-fromTextArea">fromTextArea</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ensureGlobalHandlers">ensureGlobalHandlers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onKeyDown">onKeyDown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onKeyPress">onKeyPress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onKeyUp">onKeyUp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addLegacyProps">addLegacyProps</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-methods">methods</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clickInGutter">clickInGutter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onContextMenu">onContextMenu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-onMouseDown">onMouseDown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-defineOptions">defineOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-themeChanged">themeChanged</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commands">commands</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Init">Init</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaults">defaults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-optionHandlers">optionHandlers</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">expertMode/codemirror-5.20.2/src/input</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ContentEditableInput">ContentEditableInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-TextareaInput">TextareaInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-indentLine">indentLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-applyTextInput">applyTextInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-copyableRanges">copyableRanges</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-disableBrowserMagic">disableBrowserMagic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-handlePaste">handlePaste</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hiddenTextarea">hiddenTextarea</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setLastCopied">setLastCopied</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-triggerElectric">triggerElectric</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getKeyMap">getKeyMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isModifierKey">isModifierKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-keyName">keyName</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lookupKey">lookupKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-normalizeKeyMap">normalizeKeyMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-lastCopied">lastCopied</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-keyMap">keyMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-keyNames">keyNames</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">expertMode/codemirror-5.20.2/src/line</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getLineStyles">getLineStyles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getStateBefore">getStateBefore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-highlightLine">highlightLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-processLine">processLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readToken">readToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-takeToken">takeToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Line">Line</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-LineView">LineView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildLineContent">buildLineContent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildViewArray">buildViewArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanUpLine">cleanUpLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-defaultSpecialCharPlaceholder">defaultSpecialCharPlaceholder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateLine">updateLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Pos">Pos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clipLine">clipLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clipPos">clipPos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clipPosArray">clipPosArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cmp">cmp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-copyPos">copyPos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-maxPos">maxPos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-minPos">minPos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-seeCollapsedSpans">seeCollapsedSpans</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-seeReadOnlySpans">seeReadOnlySpans</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MarkedSpan">MarkedSpan</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addMarkedSpan">addMarkedSpan</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-attachMarkedSpans">attachMarkedSpans</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-collapsedSpanAtEnd">collapsedSpanAtEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-collapsedSpanAtStart">collapsedSpanAtStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-compareCollapsedMarkers">compareCollapsedMarkers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-conflictingCollapsedRange">conflictingCollapsedRange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-detachMarkedSpans">detachMarkedSpans</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-findMaxLine">findMaxLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getMarkedSpanFor">getMarkedSpanFor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-heightAtLine">heightAtLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lineIsHidden">lineIsHidden</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lineLength">lineLength</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeMarkedSpan">removeMarkedSpan</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeReadOnlyRanges">removeReadOnlyRanges</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stretchSpansOverChange">stretchSpansOverChange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-visualLine">visualLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-visualLineContinued">visualLineContinued</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-visualLineEndNo">visualLineEndNo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-visualLineNo">visualLineNo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBetween">getBetween</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getLine">getLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getLines">getLines</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isLine">isLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lineAtHeight">lineAtHeight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lineNo">lineNo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lineNumberFor">lineNumberFor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateLineHeight">updateLineHeight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sawReadOnlySpans">sawReadOnlySpans</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">expertMode/codemirror-5.20.2/src/measurement</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-charCoords">charCoords</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-charWidth">charWidth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clearCaches">clearCaches</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clearLineMeasurementCache">clearLineMeasurementCache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clearLineMeasurementCacheFor">clearLineMeasurementCacheFor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-compensateForHScroll">compensateForHScroll</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-coordsChar">coordsChar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cursorCoords">cursorCoords</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-displayHeight">displayHeight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-displayWidth">displayWidth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-estimateCoords">estimateCoords</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-estimateHeight">estimateHeight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-estimateLineHeights">estimateLineHeights</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-findViewForLine">findViewForLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-findViewIndex">findViewIndex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-fromCoordSystem">fromCoordSystem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDimensions">getDimensions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-intoCoordSystem">intoCoordSystem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mapFromLineView">mapFromLineView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-measureChar">measureChar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nodeAndOffsetInLineMap">nodeAndOffsetInLineMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-paddingH">paddingH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-paddingTop">paddingTop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-paddingVert">paddingVert</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-posFromMouse">posFromMouse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-scrollGap">scrollGap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-textHeight">textHeight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eventInWidget">eventInWidget</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-widgetHeight">widgetHeight</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">expertMode/codemirror-5.20.2/src/model</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Doc">Doc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-changeEnd">changeEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-computeReplacedSel">computeReplacedSel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-computeSelAfterChange">computeSelAfterChange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-changeLine">changeLine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-makeChange">makeChange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-makeChangeFromHistory">makeChangeFromHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-replaceRange">replaceRange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-BranchChunk">BranchChunk</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-LeafChunk">LeafChunk</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-attachDoc">attachDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isWholeLineUpdate">isWholeLineUpdate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-linkedDocs">linkedDocs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateDoc">updateDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-History">History</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addChangeToHistory">addChangeToHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addSelectionToHistory">addSelectionToHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-copyHistoryArray">copyHistoryArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-historyChangeFromChange">historyChangeFromChange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mergeOldSpans">mergeOldSpans</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pushSelectionToHistory">pushSelectionToHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-LineWidget">LineWidget</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addLineWidget">addLineWidget</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SharedTextMarker">SharedTextMarker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-TextMarker">TextMarker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-copySharedMarkers">copySharedMarkers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-detachSharedMarkers">detachSharedMarkers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-findSharedMarkers">findSharedMarkers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-markText">markText</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Range">Range</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Selection">Selection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-normalizeSelection">normalizeSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-simpleSelection">simpleSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extendRange">extendRange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extendSelection">extendSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extendSelections">extendSelections</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-reCheckSelection">reCheckSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-replaceOneSelection">replaceOneSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-selectAll">selectAll</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setSelection">setSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setSelectionNoUndo">setSelectionNoUndo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setSelectionReplaceHistory">setSelectionReplaceHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setSimpleSelection">setSimpleSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-skipAtomic">skipAtomic</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">expertMode/codemirror-5.20.2/src/util</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-StringStream">StringStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bidiLeft">bidiLeft</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bidiRight">bidiRight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBidiPartAt">getBidiPartAt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getOrder">getOrder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-iterateBidiSections">iterateBidiSections</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lineLeft">lineLeft</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lineRight">lineRight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-moveLogically">moveLogically</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-moveVisually">moveVisually</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-activeElt">activeElt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addClass">addClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-classTest">classTest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-contains">contains</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-elt">elt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-joinClasses">joinClasses</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeChildren">removeChildren</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeChildrenAndAdd">removeChildrenAndAdd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rmClass">rmClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-selectInput">selectInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-e_button">e_button</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-e_defaultPrevented">e_defaultPrevented</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-e_preventDefault">e_preventDefault</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-e_stop">e_stop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-e_stopPropagation">e_stopPropagation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-e_target">e_target</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eventMixin">eventMixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getHandlers">getHandlers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hasHandler">hasHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-off">off</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-on">on</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-signal">signal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-signalCursorActivity">signalCursorActivity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-signalDOMEvent">signalDOMEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hasBadBidiRects">hasBadBidiRects</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hasBadZoomedRects">hasBadZoomedRects</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-zeroWidthElement">zeroWidthElement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Delayed">Delayed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bind">bind</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-copyObj">copyObj</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-countColumn">countColumn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createObj">createObj</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-findColumn">findColumn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-indexOf">indexOf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertSorted">insertSorted</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isEmpty">isEmpty</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isExtendingChar">isExtendingChar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isWordChar">isWordChar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isWordCharBasic">isWordCharBasic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lst">lst</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-map">map</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nothing">nothing</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-spaceStr">spaceStr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-finishOperation">finishOperation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pushOperation">pushOperation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-signalLater">signalLater</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bidiOrdering">bidiOrdering</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bidiOther">bidiOther</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-captureRightClick">captureRightClick</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-chrome">chrome</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-chromeOS">chromeOS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-flipCtrlCmd">flipCtrlCmd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-gecko">gecko</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ie">ie</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ie_version">ie_version</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ios">ios</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mac">mac</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mac_geMountainLion">mac_geMountainLion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mobile">mobile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-phantom">phantom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-presto">presto</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-safari">safari</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-webkit">webkit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-windows">windows</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dragAndDrop">dragAndDrop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-hasCopyEvent">hasCopyEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-hasSelection">hasSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-splitLinesAuto">splitLinesAuto</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Pass">Pass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-scrollerGap">scrollerGap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sel_dontScroll">sel_dontScroll</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">App/expertMode/codemirror-5.20.2/test/test.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">var Pos = CodeMirror.Pos;

CodeMirror.defaults.rtlMoveVisually = true;

function forEach(arr, f) {
  for (var i = 0, e = arr.length; i &lt; e; ++i) f(arr[i], i);
}

function addDoc(cm, width, height) {
  var content = [], line = &quot;&quot;;
  for (var i = 0; i &lt; width; ++i) line += &quot;x&quot;;
  for (var i = 0; i &lt; height; ++i) content.push(line);
  cm.setValue(content.join(&quot;\n&quot;));
}

function byClassName(elt, cls) {
  if (elt.getElementsByClassName) return elt.getElementsByClassName(cls);
  var found = [], re = new RegExp(&quot;\\b&quot; + cls + &quot;\\b&quot;);
  function search(elt) {
    if (elt.nodeType == 3) return;
    if (re.test(elt.className)) found.push(elt);
    for (var i = 0, e = elt.childNodes.length; i &lt; e; ++i)
      search(elt.childNodes[i]);
  }
  search(elt);
  return found;
}

var ie_lt8 = /MSIE [1-7]\b/.test(navigator.userAgent);
var ie_lt9 = /MSIE [1-8]\b/.test(navigator.userAgent);
var mac = /Mac/.test(navigator.platform);
var phantom = /PhantomJS/.test(navigator.userAgent);
var opera = /Opera\/\./.test(navigator.userAgent);
var opera_version = opera &amp;&amp; navigator.userAgent.match(/Version\/(\d+\.\d+)/);
if (opera_version) opera_version = Number(opera_version);
var opera_lt10 = opera &amp;&amp; (!opera_version || opera_version &lt; 10);

namespace = &quot;core_&quot;;

test(&quot;core_fromTextArea&quot;, function() {
  var te = document.getElementById(&quot;code&quot;);
  te.value = &quot;CONTENT&quot;;
  var cm = CodeMirror.fromTextArea(te);
  is(!te.offsetHeight);
  eq(cm.getValue(), &quot;CONTENT&quot;);
  cm.setValue(&quot;foo\nbar&quot;);
  eq(cm.getValue(), &quot;foo\nbar&quot;);
  cm.save();
  is(/^foo\r?\nbar$/.test(te.value));
  cm.setValue(&quot;xxx&quot;);
  cm.toTextArea();
  is(te.offsetHeight);
  eq(te.value, &quot;xxx&quot;);
});

testCM(&quot;getRange&quot;, function(cm) {
  eq(cm.getLine(0), &quot;1234&quot;);
  eq(cm.getLine(1), &quot;5678&quot;);
  eq(cm.getLine(2), null);
  eq(cm.getLine(-1), null);
  eq(cm.getRange(Pos(0, 0), Pos(0, 3)), &quot;123&quot;);
  eq(cm.getRange(Pos(0, -1), Pos(0, 200)), &quot;1234&quot;);
  eq(cm.getRange(Pos(0, 2), Pos(1, 2)), &quot;34\n56&quot;);
  eq(cm.getRange(Pos(1, 2), Pos(100, 0)), &quot;78&quot;);
}, {value: &quot;1234\n5678&quot;});

testCM(&quot;replaceRange&quot;, function(cm) {
  eq(cm.getValue(), &quot;&quot;);
  cm.replaceRange(&quot;foo\n&quot;, Pos(0, 0));
  eq(cm.getValue(), &quot;foo\n&quot;);
  cm.replaceRange(&quot;a\nb&quot;, Pos(0, 1));
  eq(cm.getValue(), &quot;fa\nboo\n&quot;);
  eq(cm.lineCount(), 3);
  cm.replaceRange(&quot;xyzzy&quot;, Pos(0, 0), Pos(1, 1));
  eq(cm.getValue(), &quot;xyzzyoo\n&quot;);
  cm.replaceRange(&quot;abc&quot;, Pos(0, 0), Pos(10, 0));
  eq(cm.getValue(), &quot;abc&quot;);
  eq(cm.lineCount(), 1);
});

testCM(&quot;selection&quot;, function(cm) {
  cm.setSelection(Pos(0, 4), Pos(2, 2));
  is(cm.somethingSelected());
  eq(cm.getSelection(), &quot;11\n222222\n33&quot;);
  eqPos(cm.getCursor(false), Pos(2, 2));
  eqPos(cm.getCursor(true), Pos(0, 4));
  cm.setSelection(Pos(1, 0));
  is(!cm.somethingSelected());
  eq(cm.getSelection(), &quot;&quot;);
  eqPos(cm.getCursor(true), Pos(1, 0));
  cm.replaceSelection(&quot;abc&quot;, &quot;around&quot;);
  eq(cm.getSelection(), &quot;abc&quot;);
  eq(cm.getValue(), &quot;111111\nabc222222\n333333&quot;);
  cm.replaceSelection(&quot;def&quot;, &quot;end&quot;);
  eq(cm.getSelection(), &quot;&quot;);
  eqPos(cm.getCursor(true), Pos(1, 3));
  cm.setCursor(Pos(2, 1));
  eqPos(cm.getCursor(true), Pos(2, 1));
  cm.setCursor(1, 2);
  eqPos(cm.getCursor(true), Pos(1, 2));
}, {value: &quot;111111\n222222\n333333&quot;});

testCM(&quot;extendSelection&quot;, function(cm) {
  cm.setExtending(true);
  addDoc(cm, 10, 10);
  cm.setSelection(Pos(3, 5));
  eqPos(cm.getCursor(&quot;head&quot;), Pos(3, 5));
  eqPos(cm.getCursor(&quot;anchor&quot;), Pos(3, 5));
  cm.setSelection(Pos(2, 5), Pos(5, 5));
  eqPos(cm.getCursor(&quot;head&quot;), Pos(5, 5));
  eqPos(cm.getCursor(&quot;anchor&quot;), Pos(2, 5));
  eqPos(cm.getCursor(&quot;start&quot;), Pos(2, 5));
  eqPos(cm.getCursor(&quot;end&quot;), Pos(5, 5));
  cm.setSelection(Pos(5, 5), Pos(2, 5));
  eqPos(cm.getCursor(&quot;head&quot;), Pos(2, 5));
  eqPos(cm.getCursor(&quot;anchor&quot;), Pos(5, 5));
  eqPos(cm.getCursor(&quot;start&quot;), Pos(2, 5));
  eqPos(cm.getCursor(&quot;end&quot;), Pos(5, 5));
  cm.extendSelection(Pos(3, 2));
  eqPos(cm.getCursor(&quot;head&quot;), Pos(3, 2));
  eqPos(cm.getCursor(&quot;anchor&quot;), Pos(5, 5));
  cm.extendSelection(Pos(6, 2));
  eqPos(cm.getCursor(&quot;head&quot;), Pos(6, 2));
  eqPos(cm.getCursor(&quot;anchor&quot;), Pos(5, 5));
  cm.extendSelection(Pos(6, 3), Pos(6, 4));
  eqPos(cm.getCursor(&quot;head&quot;), Pos(6, 4));
  eqPos(cm.getCursor(&quot;anchor&quot;), Pos(5, 5));
  cm.extendSelection(Pos(0, 3), Pos(0, 4));
  eqPos(cm.getCursor(&quot;head&quot;), Pos(0, 3));
  eqPos(cm.getCursor(&quot;anchor&quot;), Pos(5, 5));
  cm.extendSelection(Pos(4, 5), Pos(6, 5));
  eqPos(cm.getCursor(&quot;head&quot;), Pos(6, 5));
  eqPos(cm.getCursor(&quot;anchor&quot;), Pos(4, 5));
  cm.setExtending(false);
  cm.extendSelection(Pos(0, 3), Pos(0, 4));
  eqPos(cm.getCursor(&quot;head&quot;), Pos(0, 3));
  eqPos(cm.getCursor(&quot;anchor&quot;), Pos(0, 4));
});

testCM(&quot;lines&quot;, function(cm) {
  eq(cm.getLine(0), &quot;111111&quot;);
  eq(cm.getLine(1), &quot;222222&quot;);
  eq(cm.getLine(-1), null);
  cm.replaceRange(&quot;&quot;, Pos(1, 0), Pos(2, 0))
  cm.replaceRange(&quot;abc&quot;, Pos(1, 0), Pos(1));
  eq(cm.getValue(), &quot;111111\nabc&quot;);
}, {value: &quot;111111\n222222\n333333&quot;});

testCM(&quot;indent&quot;, function(cm) {
  cm.indentLine(1);
  eq(cm.getLine(1), &quot;   blah();&quot;);
  cm.setOption(&quot;indentUnit&quot;, 8);
  cm.indentLine(1);
  eq(cm.getLine(1), &quot;\tblah();&quot;);
  cm.setOption(&quot;indentUnit&quot;, 10);
  cm.setOption(&quot;tabSize&quot;, 4);
  cm.indentLine(1);
  eq(cm.getLine(1), &quot;\t\t  blah();&quot;);
}, {value: &quot;if (x) {\nblah();\n}&quot;, indentUnit: 3, indentWithTabs: true, tabSize: 8});

testCM(&quot;indentByNumber&quot;, function(cm) {
  cm.indentLine(0, 2);
  eq(cm.getLine(0), &quot;  foo&quot;);
  cm.indentLine(0, -200);
  eq(cm.getLine(0), &quot;foo&quot;);
  cm.setSelection(Pos(0, 0), Pos(1, 2));
  cm.indentSelection(3);
  eq(cm.getValue(), &quot;   foo\n   bar\nbaz&quot;);
}, {value: &quot;foo\nbar\nbaz&quot;});

test(&quot;core_defaults&quot;, function() {
  var defsCopy = {}, defs = CodeMirror.defaults;
  for (var opt in defs) defsCopy[opt] = defs[opt];
  defs.indentUnit = 5;
  defs.value = &quot;uu&quot;;
  defs.indentWithTabs = true;
  defs.tabindex = 55;
  var place = document.getElementById(&quot;testground&quot;), cm = CodeMirror(place);
  try {
    eq(cm.getOption(&quot;indentUnit&quot;), 5);
    cm.setOption(&quot;indentUnit&quot;, 10);
    eq(defs.indentUnit, 5);
    eq(cm.getValue(), &quot;uu&quot;);
    eq(cm.getOption(&quot;indentWithTabs&quot;), true);
    eq(cm.getInputField().tabIndex, 55);
  }
  finally {
    for (var opt in defsCopy) defs[opt] = defsCopy[opt];
    place.removeChild(cm.getWrapperElement());
  }
});

testCM(&quot;lineInfo&quot;, function(cm) {
  eq(cm.lineInfo(-1), null);
  var mark = document.createElement(&quot;span&quot;);
  var lh = cm.setGutterMarker(1, &quot;FOO&quot;, mark);
  var info = cm.lineInfo(1);
  eq(info.text, &quot;222222&quot;);
  eq(info.gutterMarkers.FOO, mark);
  eq(info.line, 1);
  eq(cm.lineInfo(2).gutterMarkers, null);
  cm.setGutterMarker(lh, &quot;FOO&quot;, null);
  eq(cm.lineInfo(1).gutterMarkers, null);
  cm.setGutterMarker(1, &quot;FOO&quot;, mark);
  cm.setGutterMarker(0, &quot;FOO&quot;, mark);
  cm.clearGutter(&quot;FOO&quot;);
  eq(cm.lineInfo(0).gutterMarkers, null);
  eq(cm.lineInfo(1).gutterMarkers, null);
}, {value: &quot;111111\n222222\n333333&quot;});

testCM(&quot;coords&quot;, function(cm) {
  cm.setSize(null, 100);
  addDoc(cm, 32, 200);
  var top = cm.charCoords(Pos(0, 0));
  var bot = cm.charCoords(Pos(200, 30));
  is(top.left &lt; bot.left);
  is(top.top &lt; bot.top);
  is(top.top &lt; top.bottom);
  cm.scrollTo(null, 100);
  var top2 = cm.charCoords(Pos(0, 0));
  is(top.top &gt; top2.top);
  eq(top.left, top2.left);
});

testCM(&quot;coordsChar&quot;, function(cm) {
  addDoc(cm, 35, 70);
  for (var i = 0; i &lt; 2; ++i) {
    var sys = i ? &quot;local&quot; : &quot;page&quot;;
    for (var ch = 0; ch &lt;= 35; ch += 5) {
      for (var line = 0; line &lt; 70; line += 5) {
        cm.setCursor(line, ch);
        var coords = cm.charCoords(Pos(line, ch), sys);
        var pos = cm.coordsChar({left: coords.left + 1, top: coords.top + 1}, sys);
        eqPos(pos, Pos(line, ch));
      }
    }
  }
}, {lineNumbers: true});

testCM(&quot;posFromIndex&quot;, function(cm) {
  cm.setValue(
    &quot;This function should\n&quot; +
    &quot;convert a zero based index\n&quot; +
    &quot;to line and ch.&quot;
  );

  var examples = [
    { index: -1, line: 0, ch: 0  }, // &lt;- Tests clipping
    { index: 0,  line: 0, ch: 0  },
    { index: 10, line: 0, ch: 10 },
    { index: 39, line: 1, ch: 18 },
    { index: 55, line: 2, ch: 7  },
    { index: 63, line: 2, ch: 15 },
    { index: 64, line: 2, ch: 15 }  // &lt;- Tests clipping
  ];

  for (var i = 0; i &lt; examples.length; i++) {
    var example = examples[i];
    var pos = cm.posFromIndex(example.index);
    eq(pos.line, example.line);
    eq(pos.ch, example.ch);
    if (example.index &gt;= 0 &amp;&amp; example.index &lt; 64)
      eq(cm.indexFromPos(pos), example.index);
  }
});

testCM(&quot;undo&quot;, function(cm) {
  cm.replaceRange(&quot;def&quot;, Pos(0, 0), Pos(0));
  eq(cm.historySize().undo, 1);
  cm.undo();
  eq(cm.getValue(), &quot;abc&quot;);
  eq(cm.historySize().undo, 0);
  eq(cm.historySize().redo, 1);
  cm.redo();
  eq(cm.getValue(), &quot;def&quot;);
  eq(cm.historySize().undo, 1);
  eq(cm.historySize().redo, 0);
  cm.setValue(&quot;1\n\n\n2&quot;);
  cm.clearHistory();
  eq(cm.historySize().undo, 0);
  for (var i = 0; i &lt; 20; ++i) {
    cm.replaceRange(&quot;a&quot;, Pos(0, 0));
    cm.replaceRange(&quot;b&quot;, Pos(3, 0));
  }
  eq(cm.historySize().undo, 40);
  for (var i = 0; i &lt; 40; ++i)
    cm.undo();
  eq(cm.historySize().redo, 40);
  eq(cm.getValue(), &quot;1\n\n\n2&quot;);
}, {value: &quot;abc&quot;});

testCM(&quot;undoDepth&quot;, function(cm) {
  cm.replaceRange(&quot;d&quot;, Pos(0));
  cm.replaceRange(&quot;e&quot;, Pos(0));
  cm.replaceRange(&quot;f&quot;, Pos(0));
  cm.undo(); cm.undo(); cm.undo();
  eq(cm.getValue(), &quot;abcd&quot;);
}, {value: &quot;abc&quot;, undoDepth: 4});

testCM(&quot;undoDoesntClearValue&quot;, function(cm) {
  cm.undo();
  eq(cm.getValue(), &quot;x&quot;);
}, {value: &quot;x&quot;});

testCM(&quot;undoMultiLine&quot;, function(cm) {
  cm.operation(function() {
    cm.replaceRange(&quot;x&quot;, Pos(0, 0));
    cm.replaceRange(&quot;y&quot;, Pos(1, 0));
  });
  cm.undo();
  eq(cm.getValue(), &quot;abc\ndef\nghi&quot;);
  cm.operation(function() {
    cm.replaceRange(&quot;y&quot;, Pos(1, 0));
    cm.replaceRange(&quot;x&quot;, Pos(0, 0));
  });
  cm.undo();
  eq(cm.getValue(), &quot;abc\ndef\nghi&quot;);
  cm.operation(function() {
    cm.replaceRange(&quot;y&quot;, Pos(2, 0));
    cm.replaceRange(&quot;x&quot;, Pos(1, 0));
    cm.replaceRange(&quot;z&quot;, Pos(2, 0));
  });
  cm.undo();
  eq(cm.getValue(), &quot;abc\ndef\nghi&quot;, 3);
}, {value: &quot;abc\ndef\nghi&quot;});

testCM(&quot;undoComposite&quot;, function(cm) {
  cm.replaceRange(&quot;y&quot;, Pos(1));
  cm.operation(function() {
    cm.replaceRange(&quot;x&quot;, Pos(0));
    cm.replaceRange(&quot;z&quot;, Pos(2));
  });
  eq(cm.getValue(), &quot;ax\nby\ncz\n&quot;);
  cm.undo();
  eq(cm.getValue(), &quot;a\nby\nc\n&quot;);
  cm.undo();
  eq(cm.getValue(), &quot;a\nb\nc\n&quot;);
  cm.redo(); cm.redo();
  eq(cm.getValue(), &quot;ax\nby\ncz\n&quot;);
}, {value: &quot;a\nb\nc\n&quot;});

testCM(&quot;undoSelection&quot;, function(cm) {
  cm.setSelection(Pos(0, 2), Pos(0, 4));
  cm.replaceSelection(&quot;&quot;);
  cm.setCursor(Pos(1, 0));
  cm.undo();
  eqPos(cm.getCursor(true), Pos(0, 2));
  eqPos(cm.getCursor(false), Pos(0, 4));
  cm.setCursor(Pos(1, 0));
  cm.redo();
  eqPos(cm.getCursor(true), Pos(0, 2));
  eqPos(cm.getCursor(false), Pos(0, 2));
}, {value: &quot;abcdefgh\n&quot;});

testCM(&quot;undoSelectionAsBefore&quot;, function(cm) {
  cm.replaceSelection(&quot;abc&quot;, &quot;around&quot;);
  cm.undo();
  cm.redo();
  eq(cm.getSelection(), &quot;abc&quot;);
});

testCM(&quot;selectionChangeConfusesHistory&quot;, function(cm) {
  cm.replaceSelection(&quot;abc&quot;, null, &quot;dontmerge&quot;);
  cm.operation(function() {
    cm.setCursor(Pos(0, 0));
    cm.replaceSelection(&quot;abc&quot;, null, &quot;dontmerge&quot;);
  });
  eq(cm.historySize().undo, 2);
});

testCM(&quot;markTextSingleLine&quot;, function(cm) {
  forEach([{a: 0, b: 1, c: &quot;&quot;, f: 2, t: 5},
           {a: 0, b: 4, c: &quot;&quot;, f: 0, t: 2},
           {a: 1, b: 2, c: &quot;x&quot;, f: 3, t: 6},
           {a: 4, b: 5, c: &quot;&quot;, f: 3, t: 5},
           {a: 4, b: 5, c: &quot;xx&quot;, f: 3, t: 7},
           {a: 2, b: 5, c: &quot;&quot;, f: 2, t: 3},
           {a: 2, b: 5, c: &quot;abcd&quot;, f: 6, t: 7},
           {a: 2, b: 6, c: &quot;x&quot;, f: null, t: null},
           {a: 3, b: 6, c: &quot;&quot;, f: null, t: null},
           {a: 0, b: 9, c: &quot;hallo&quot;, f: null, t: null},
           {a: 4, b: 6, c: &quot;x&quot;, f: 3, t: 4},
           {a: 4, b: 8, c: &quot;&quot;, f: 3, t: 4},
           {a: 6, b: 6, c: &quot;a&quot;, f: 3, t: 6},
           {a: 8, b: 9, c: &quot;&quot;, f: 3, t: 6}], function(test) {
    cm.setValue(&quot;1234567890&quot;);
    var r = cm.markText(Pos(0, 3), Pos(0, 6), {className: &quot;foo&quot;});
    cm.replaceRange(test.c, Pos(0, test.a), Pos(0, test.b));
    var f = r.find();
    eq(f &amp;&amp; f.from.ch, test.f); eq(f &amp;&amp; f.to.ch, test.t);
  });
});

testCM(&quot;markTextMultiLine&quot;, function(cm) {
  function p(v) { return v &amp;&amp; Pos(v[0], v[1]); }
  forEach([{a: [0, 0], b: [0, 5], c: &quot;&quot;, f: [0, 0], t: [2, 5]},
           {a: [0, 0], b: [0, 5], c: &quot;foo\n&quot;, f: [1, 0], t: [3, 5]},
           {a: [0, 1], b: [0, 10], c: &quot;&quot;, f: [0, 1], t: [2, 5]},
           {a: [0, 5], b: [0, 6], c: &quot;x&quot;, f: [0, 6], t: [2, 5]},
           {a: [0, 0], b: [1, 0], c: &quot;&quot;, f: [0, 0], t: [1, 5]},
           {a: [0, 6], b: [2, 4], c: &quot;&quot;, f: [0, 5], t: [0, 7]},
           {a: [0, 6], b: [2, 4], c: &quot;aa&quot;, f: [0, 5], t: [0, 9]},
           {a: [1, 2], b: [1, 8], c: &quot;&quot;, f: [0, 5], t: [2, 5]},
           {a: [0, 5], b: [2, 5], c: &quot;xx&quot;, f: null, t: null},
           {a: [0, 0], b: [2, 10], c: &quot;x&quot;, f: null, t: null},
           {a: [1, 5], b: [2, 5], c: &quot;&quot;, f: [0, 5], t: [1, 5]},
           {a: [2, 0], b: [2, 3], c: &quot;&quot;, f: [0, 5], t: [2, 2]},
           {a: [2, 5], b: [3, 0], c: &quot;a\nb&quot;, f: [0, 5], t: [2, 5]},
           {a: [2, 3], b: [3, 0], c: &quot;x&quot;, f: [0, 5], t: [2, 3]},
           {a: [1, 1], b: [1, 9], c: &quot;1\n2\n3&quot;, f: [0, 5], t: [4, 5]}], function(test) {
    cm.setValue(&quot;aaaaaaaaaa\nbbbbbbbbbb\ncccccccccc\ndddddddd\n&quot;);
    var r = cm.markText(Pos(0, 5), Pos(2, 5),
                        {className: &quot;CodeMirror-matchingbracket&quot;});
    cm.replaceRange(test.c, p(test.a), p(test.b));
    var f = r.find();
    eqPos(f &amp;&amp; f.from, p(test.f)); eqPos(f &amp;&amp; f.to, p(test.t));
  });
});

testCM(&quot;markTextUndo&quot;, function(cm) {
  var marker1, marker2, bookmark;
  marker1 = cm.markText(Pos(0, 1), Pos(0, 3),
                        {className: &quot;CodeMirror-matchingbracket&quot;});
  marker2 = cm.markText(Pos(0, 0), Pos(2, 1),
                        {className: &quot;CodeMirror-matchingbracket&quot;});
  bookmark = cm.setBookmark(Pos(1, 5));
  cm.operation(function(){
    cm.replaceRange(&quot;foo&quot;, Pos(0, 2));
    cm.replaceRange(&quot;bar\nbaz\nbug\n&quot;, Pos(2, 0), Pos(3, 0));
  });
  var v1 = cm.getValue();
  cm.setValue(&quot;&quot;);
  eq(marker1.find(), null); eq(marker2.find(), null); eq(bookmark.find(), null);
  cm.undo();
  eqPos(bookmark.find(), Pos(1, 5), &quot;still there&quot;);
  cm.undo();
  var m1Pos = marker1.find(), m2Pos = marker2.find();
  eqPos(m1Pos.from, Pos(0, 1)); eqPos(m1Pos.to, Pos(0, 3));
  eqPos(m2Pos.from, Pos(0, 0)); eqPos(m2Pos.to, Pos(2, 1));
  eqPos(bookmark.find(), Pos(1, 5));
  cm.redo(); cm.redo();
  eq(bookmark.find(), null);
  cm.undo();
  eqPos(bookmark.find(), Pos(1, 5));
  eq(cm.getValue(), v1);
}, {value: &quot;1234\n56789\n00\n&quot;});

testCM(&quot;markTextStayGone&quot;, function(cm) {
  var m1 = cm.markText(Pos(0, 0), Pos(0, 1));
  cm.replaceRange(&quot;hi&quot;, Pos(0, 2));
  m1.clear();
  cm.undo();
  eq(m1.find(), null);
}, {value: &quot;hello&quot;});

testCM(&quot;markTextAllowEmpty&quot;, function(cm) {
  var m1 = cm.markText(Pos(0, 1), Pos(0, 2), {clearWhenEmpty: false});
  is(m1.find());
  cm.replaceRange(&quot;x&quot;, Pos(0, 0));
  is(m1.find());
  cm.replaceRange(&quot;y&quot;, Pos(0, 2));
  is(m1.find());
  cm.replaceRange(&quot;z&quot;, Pos(0, 3), Pos(0, 4));
  is(!m1.find());
  var m2 = cm.markText(Pos(0, 1), Pos(0, 2), {clearWhenEmpty: false,
                                              inclusiveLeft: true,
                                              inclusiveRight: true});
  cm.replaceRange(&quot;q&quot;, Pos(0, 1), Pos(0, 2));
  is(m2.find());
  cm.replaceRange(&quot;&quot;, Pos(0, 0), Pos(0, 3));
  is(!m2.find());
  var m3 = cm.markText(Pos(0, 1), Pos(0, 1), {clearWhenEmpty: false});
  cm.replaceRange(&quot;a&quot;, Pos(0, 3));
  is(m3.find());
  cm.replaceRange(&quot;b&quot;, Pos(0, 1));
  is(!m3.find());
}, {value: &quot;abcde&quot;});

testCM(&quot;markTextStacked&quot;, function(cm) {
  var m1 = cm.markText(Pos(0, 0), Pos(0, 0), {clearWhenEmpty: false});
  var m2 = cm.markText(Pos(0, 0), Pos(0, 0), {clearWhenEmpty: false});
  cm.replaceRange(&quot;B&quot;, Pos(0, 1));
  is(m1.find() &amp;&amp; m2.find());
}, {value: &quot;A&quot;});

testCM(&quot;undoPreservesNewMarks&quot;, function(cm) {
  cm.markText(Pos(0, 3), Pos(0, 4));
  cm.markText(Pos(1, 1), Pos(1, 3));
  cm.replaceRange(&quot;&quot;, Pos(0, 3), Pos(3, 1));
  var mBefore = cm.markText(Pos(0, 0), Pos(0, 1));
  var mAfter = cm.markText(Pos(0, 5), Pos(0, 6));
  var mAround = cm.markText(Pos(0, 2), Pos(0, 4));
  cm.undo();
  eqPos(mBefore.find().from, Pos(0, 0));
  eqPos(mBefore.find().to, Pos(0, 1));
  eqPos(mAfter.find().from, Pos(3, 3));
  eqPos(mAfter.find().to, Pos(3, 4));
  eqPos(mAround.find().from, Pos(0, 2));
  eqPos(mAround.find().to, Pos(3, 2));
  var found = cm.findMarksAt(Pos(2, 2));
  eq(found.length, 1);
  eq(found[0], mAround);
}, {value: &quot;aaaa\nbbbb\ncccc\ndddd&quot;});

testCM(&quot;markClearBetween&quot;, function(cm) {
  cm.setValue(&quot;aaa\nbbb\nccc\nddd\n&quot;);
  cm.markText(Pos(0, 0), Pos(2));
  cm.replaceRange(&quot;aaa\nbbb\nccc&quot;, Pos(0, 0), Pos(2));
  eq(cm.findMarksAt(Pos(1, 1)).length, 0);
});

testCM(&quot;findMarksMiddle&quot;, function(cm) {
  var mark = cm.markText(Pos(1, 1), Pos(3, 1));
  var found = cm.findMarks(Pos(2, 1), Pos(2, 2));
  eq(found.length, 1);
  eq(found[0], mark);
}, {value: &quot;line 0\nline 1\nline 2\nline 3&quot;});

testCM(&quot;deleteSpanCollapsedInclusiveLeft&quot;, function(cm) {
  var from = Pos(1, 0), to = Pos(1, 1);
  var m = cm.markText(from, to, {collapsed: true, inclusiveLeft: true});
  // Delete collapsed span.
  cm.replaceRange(&quot;&quot;, from, to);
}, {value: &quot;abc\nX\ndef&quot;});

testCM(&quot;markTextCSS&quot;, function(cm) {
  function present() {
    var spans = cm.display.lineDiv.getElementsByTagName(&quot;span&quot;);
    for (var i = 0; i &lt; spans.length; i++)
      if (spans[i].style.color == &quot;cyan&quot; &amp;&amp; span[i].textContent == &quot;cdefg&quot;) return true;
  }
  var m = cm.markText(Pos(0, 2), Pos(0, 6), {css: &quot;color: cyan&quot;});
  m.clear();
  is(!present());
}, {value: &quot;abcdefgh&quot;});

testCM(&quot;bookmark&quot;, function(cm) {
  function p(v) { return v &amp;&amp; Pos(v[0], v[1]); }
  forEach([{a: [1, 0], b: [1, 1], c: &quot;&quot;, d: [1, 4]},
           {a: [1, 1], b: [1, 1], c: &quot;xx&quot;, d: [1, 7]},
           {a: [1, 4], b: [1, 5], c: &quot;ab&quot;, d: [1, 6]},
           {a: [1, 4], b: [1, 6], c: &quot;&quot;, d: null},
           {a: [1, 5], b: [1, 6], c: &quot;abc&quot;, d: [1, 5]},
           {a: [1, 6], b: [1, 8], c: &quot;&quot;, d: [1, 5]},
           {a: [1, 4], b: [1, 4], c: &quot;\n\n&quot;, d: [3, 1]},
           {bm: [1, 9], a: [1, 1], b: [1, 1], c: &quot;\n&quot;, d: [2, 8]}], function(test) {
    cm.setValue(&quot;1234567890\n1234567890\n1234567890&quot;);
    var b = cm.setBookmark(p(test.bm) || Pos(1, 5));
    cm.replaceRange(test.c, p(test.a), p(test.b));
    eqPos(b.find(), p(test.d));
  });
});

testCM(&quot;bookmarkInsertLeft&quot;, function(cm) {
  var br = cm.setBookmark(Pos(0, 2), {insertLeft: false});
  var bl = cm.setBookmark(Pos(0, 2), {insertLeft: true});
  cm.setCursor(Pos(0, 2));
  cm.replaceSelection(&quot;hi&quot;);
  eqPos(br.find(), Pos(0, 2));
  eqPos(bl.find(), Pos(0, 4));
  cm.replaceRange(&quot;&quot;, Pos(0, 4), Pos(0, 5));
  cm.replaceRange(&quot;&quot;, Pos(0, 2), Pos(0, 4));
  cm.replaceRange(&quot;&quot;, Pos(0, 1), Pos(0, 2));
  // Verify that deleting next to bookmarks doesn&apos;t kill them
  eqPos(br.find(), Pos(0, 1));
  eqPos(bl.find(), Pos(0, 1));
}, {value: &quot;abcdef&quot;});

testCM(&quot;bookmarkCursor&quot;, function(cm) {
  var pos01 = cm.cursorCoords(Pos(0, 1)), pos11 = cm.cursorCoords(Pos(1, 1)),
      pos20 = cm.cursorCoords(Pos(2, 0)), pos30 = cm.cursorCoords(Pos(3, 0)),
      pos41 = cm.cursorCoords(Pos(4, 1));
  cm.setBookmark(Pos(0, 1), {widget: document.createTextNode(&quot;&#x2190;&quot;), insertLeft: true});
  cm.setBookmark(Pos(2, 0), {widget: document.createTextNode(&quot;&#x2190;&quot;), insertLeft: true});
  cm.setBookmark(Pos(1, 1), {widget: document.createTextNode(&quot;&#x2192;&quot;)});
  cm.setBookmark(Pos(3, 0), {widget: document.createTextNode(&quot;&#x2192;&quot;)});
  var new01 = cm.cursorCoords(Pos(0, 1)), new11 = cm.cursorCoords(Pos(1, 1)),
      new20 = cm.cursorCoords(Pos(2, 0)), new30 = cm.cursorCoords(Pos(3, 0));
  near(new01.left, pos01.left, 1);
  near(new01.top, pos01.top, 1);
  is(new11.left &gt; pos11.left, &quot;at right, middle of line&quot;);
  near(new11.top == pos11.top, 1);
  near(new20.left, pos20.left, 1);
  near(new20.top, pos20.top, 1);
  is(new30.left &gt; pos30.left, &quot;at right, empty line&quot;);
  near(new30.top, pos30, 1);
  cm.setBookmark(Pos(4, 0), {widget: document.createTextNode(&quot;&#x2192;&quot;)});
  is(cm.cursorCoords(Pos(4, 1)).left &gt; pos41.left, &quot;single-char bug&quot;);
}, {value: &quot;foo\nbar\n\n\nx\ny&quot;});

testCM(&quot;multiBookmarkCursor&quot;, function(cm) {
  if (phantom) return;
  var ms = [], m;
  function add(insertLeft) {
    for (var i = 0; i &lt; 3; ++i) {
      var node = document.createElement(&quot;span&quot;);
      node.innerHTML = &quot;X&quot;;
      ms.push(cm.setBookmark(Pos(0, 1), {widget: node, insertLeft: insertLeft}));
    }
  }
  var base1 = cm.cursorCoords(Pos(0, 1)).left, base4 = cm.cursorCoords(Pos(0, 4)).left;
  add(true);
  near(base1, cm.cursorCoords(Pos(0, 1)).left, 1);
  while (m = ms.pop()) m.clear();
  add(false);
  near(base4, cm.cursorCoords(Pos(0, 1)).left, 1);
}, {value: &quot;abcdefg&quot;});

testCM(&quot;getAllMarks&quot;, function(cm) {
  addDoc(cm, 10, 10);
  var m1 = cm.setBookmark(Pos(0, 2));
  var m2 = cm.markText(Pos(0, 2), Pos(3, 2));
  var m3 = cm.markText(Pos(1, 2), Pos(1, 8));
  var m4 = cm.markText(Pos(8, 0), Pos(9, 0));
  eq(cm.getAllMarks().length, 4);
  m1.clear();
  m3.clear();
  eq(cm.getAllMarks().length, 2);
});

testCM(&quot;setValueClears&quot;, function(cm) {
  cm.addLineClass(0, &quot;wrap&quot;, &quot;foo&quot;);
  var mark = cm.markText(Pos(0, 0), Pos(1, 1), {inclusiveLeft: true, inclusiveRight: true});
  cm.setValue(&quot;foo&quot;);
  is(!cm.lineInfo(0).wrapClass);
  is(!mark.find());
}, {value: &quot;a\nb&quot;});

testCM(&quot;bug577&quot;, function(cm) {
  cm.setValue(&quot;a\nb&quot;);
  cm.clearHistory();
  cm.setValue(&quot;fooooo&quot;);
  cm.undo();
});

testCM(&quot;scrollSnap&quot;, function(cm) {
  cm.setSize(100, 100);
  addDoc(cm, 200, 200);
  cm.setCursor(Pos(100, 180));
  var info = cm.getScrollInfo();
  is(info.left &gt; 0 &amp;&amp; info.top &gt; 0);
  cm.setCursor(Pos(0, 0));
  info = cm.getScrollInfo();
  is(info.left == 0 &amp;&amp; info.top == 0, &quot;scrolled clean to top&quot;);
  cm.setCursor(Pos(100, 180));
  cm.setCursor(Pos(199, 0));
  info = cm.getScrollInfo();
  is(info.left == 0 &amp;&amp; info.top + 2 &gt; info.height - cm.getScrollerElement().clientHeight, &quot;scrolled clean to bottom&quot;);
});

testCM(&quot;scrollIntoView&quot;, function(cm) {
  if (phantom) return;
  var outer = cm.getWrapperElement().getBoundingClientRect();
  function test(line, ch, msg) {
    var pos = Pos(line, ch);
    cm.scrollIntoView(pos);
    var box = cm.charCoords(pos, &quot;window&quot;);
    is(box.left &gt;= outer.left, msg + &quot; (left)&quot;);
    is(box.right &lt;= outer.right, msg + &quot; (right)&quot;);
    is(box.top &gt;= outer.top, msg + &quot; (top)&quot;);
    is(box.bottom &lt;= outer.bottom, msg + &quot; (bottom)&quot;);
  }
  addDoc(cm, 200, 200);
  test(199, 199, &quot;bottom right&quot;);
  test(0, 0, &quot;top left&quot;);
  test(100, 100, &quot;center&quot;);
  test(199, 0, &quot;bottom left&quot;);
  test(0, 199, &quot;top right&quot;);
  test(100, 100, &quot;center again&quot;);
});

testCM(&quot;scrollBackAndForth&quot;, function(cm) {
  addDoc(cm, 1, 200);
  cm.operation(function() {
    cm.scrollIntoView(Pos(199, 0));
    cm.scrollIntoView(Pos(4, 0));
  });
  is(cm.getScrollInfo().top &gt; 0);
});

testCM(&quot;selectAllNoScroll&quot;, function(cm) {
  addDoc(cm, 1, 200);
  cm.execCommand(&quot;selectAll&quot;);
  eq(cm.getScrollInfo().top, 0);
  cm.setCursor(199);
  cm.execCommand(&quot;selectAll&quot;);
  is(cm.getScrollInfo().top &gt; 0);
});

testCM(&quot;selectionPos&quot;, function(cm) {
  if (phantom || cm.getOption(&quot;inputStyle&quot;) != &quot;textarea&quot;) return;
  cm.setSize(100, 100);
  addDoc(cm, 200, 100);
  cm.setSelection(Pos(1, 100), Pos(98, 100));
  var lineWidth = cm.charCoords(Pos(0, 200), &quot;local&quot;).left;
  var lineHeight = (cm.charCoords(Pos(99)).top - cm.charCoords(Pos(0)).top) / 100;
  cm.scrollTo(0, 0);
  var selElt = byClassName(cm.getWrapperElement(), &quot;CodeMirror-selected&quot;);
  var outer = cm.getWrapperElement().getBoundingClientRect();
  var sawMiddle, sawTop, sawBottom;
  for (var i = 0, e = selElt.length; i &lt; e; ++i) {
    var box = selElt[i].getBoundingClientRect();
    var atLeft = box.left - outer.left &lt; 30;
    var width = box.right - box.left;
    var atRight = box.right - outer.left &gt; .8 * lineWidth;
    if (atLeft &amp;&amp; atRight) {
      sawMiddle = true;
      is(box.bottom - box.top &gt; 90 * lineHeight, &quot;middle high&quot;);
      is(width &gt; .9 * lineWidth, &quot;middle wide&quot;);
    } else {
      is(width &gt; .4 * lineWidth, &quot;top/bot wide enough&quot;);
      is(width &lt; .6 * lineWidth, &quot;top/bot slim enough&quot;);
      if (atLeft) {
        sawBottom = true;
        is(box.top - outer.top &gt; 96 * lineHeight, &quot;bot below&quot;);
      } else if (atRight) {
        sawTop = true;
        is(box.top - outer.top &lt; 2.1 * lineHeight, &quot;top above&quot;);
      }
    }
  }
  is(sawTop &amp;&amp; sawBottom &amp;&amp; sawMiddle, &quot;all parts&quot;);
}, null);

testCM(&quot;restoreHistory&quot;, function(cm) {
  cm.setValue(&quot;abc\ndef&quot;);
  cm.replaceRange(&quot;hello&quot;, Pos(1, 0), Pos(1));
  cm.replaceRange(&quot;goop&quot;, Pos(0, 0), Pos(0));
  cm.undo();
  var storedVal = cm.getValue(), storedHist = cm.getHistory();
  if (window.JSON) storedHist = JSON.parse(JSON.stringify(storedHist));
  eq(storedVal, &quot;abc\nhello&quot;);
  cm.setValue(&quot;&quot;);
  cm.clearHistory();
  eq(cm.historySize().undo, 0);
  cm.setValue(storedVal);
  cm.setHistory(storedHist);
  cm.redo();
  eq(cm.getValue(), &quot;goop\nhello&quot;);
  cm.undo(); cm.undo();
  eq(cm.getValue(), &quot;abc\ndef&quot;);
});

testCM(&quot;doubleScrollbar&quot;, function(cm) {
  var dummy = document.body.appendChild(document.createElement(&quot;p&quot;));
  dummy.style.cssText = &quot;height: 50px; overflow: scroll; width: 50px&quot;;
  var scrollbarWidth = dummy.offsetWidth + 1 - dummy.clientWidth;
  document.body.removeChild(dummy);
  if (scrollbarWidth &lt; 2) return;
  cm.setSize(null, 100);
  addDoc(cm, 1, 300);
  var wrap = cm.getWrapperElement();
  is(wrap.offsetWidth - byClassName(wrap, &quot;CodeMirror-lines&quot;)[0].offsetWidth &lt;= scrollbarWidth * 1.5);
});

testCM(&quot;weirdLinebreaks&quot;, function(cm) {
  cm.setValue(&quot;foo\nbar\rbaz\r\nquux\n\rplop&quot;);
  is(cm.getValue(), &quot;foo\nbar\nbaz\nquux\n\nplop&quot;);
  is(cm.lineCount(), 6);
  cm.setValue(&quot;\n\n&quot;);
  is(cm.lineCount(), 3);
});

testCM(&quot;setSize&quot;, function(cm) {
  cm.setSize(100, 100);
  var wrap = cm.getWrapperElement();
  is(wrap.offsetWidth, 100);
  is(wrap.offsetHeight, 100);
  cm.setSize(&quot;100%&quot;, &quot;3em&quot;);
  is(wrap.style.width, &quot;100%&quot;);
  is(wrap.style.height, &quot;3em&quot;);
  cm.setSize(null, 40);
  is(wrap.style.width, &quot;100%&quot;);
  is(wrap.style.height, &quot;40px&quot;);
});

function foldLines(cm, start, end, autoClear) {
  return cm.markText(Pos(start, 0), Pos(end - 1), {
    inclusiveLeft: true,
    inclusiveRight: true,
    collapsed: true,
    clearOnEnter: autoClear
  });
}

testCM(&quot;collapsedLines&quot;, function(cm) {
  addDoc(cm, 4, 10);
  var range = foldLines(cm, 4, 5), cleared = 0;
  CodeMirror.on(range, &quot;clear&quot;, function() {cleared++;});
  cm.setCursor(Pos(3, 0));
  CodeMirror.commands.goLineDown(cm);
  eqPos(cm.getCursor(), Pos(5, 0));
  cm.replaceRange(&quot;abcdefg&quot;, Pos(3, 0), Pos(3));
  cm.setCursor(Pos(3, 6));
  CodeMirror.commands.goLineDown(cm);
  eqPos(cm.getCursor(), Pos(5, 4));
  cm.replaceRange(&quot;ab&quot;, Pos(3, 0), Pos(3));
  cm.setCursor(Pos(3, 2));
  CodeMirror.commands.goLineDown(cm);
  eqPos(cm.getCursor(), Pos(5, 2));
  cm.operation(function() {range.clear(); range.clear();});
  eq(cleared, 1);
});

testCM(&quot;collapsedRangeCoordsChar&quot;, function(cm) {
  var pos_1_3 = cm.charCoords(Pos(1, 3));
  pos_1_3.left += 2; pos_1_3.top += 2;
  var opts = {collapsed: true, inclusiveLeft: true, inclusiveRight: true};
  var m1 = cm.markText(Pos(0, 0), Pos(2, 0), opts);
  eqPos(cm.coordsChar(pos_1_3), Pos(3, 3));
  m1.clear();
  var m1 = cm.markText(Pos(0, 0), Pos(1, 1), {collapsed: true, inclusiveLeft: true});
  var m2 = cm.markText(Pos(1, 1), Pos(2, 0), {collapsed: true, inclusiveRight: true});
  eqPos(cm.coordsChar(pos_1_3), Pos(3, 3));
  m1.clear(); m2.clear();
  var m1 = cm.markText(Pos(0, 0), Pos(1, 6), opts);
  eqPos(cm.coordsChar(pos_1_3), Pos(3, 3));
}, {value: &quot;123456\nabcdef\nghijkl\nmnopqr\n&quot;});

testCM(&quot;collapsedRangeBetweenLinesSelected&quot;, function(cm) {
  if (cm.getOption(&quot;inputStyle&quot;) != &quot;textarea&quot;) return;
  var widget = document.createElement(&quot;span&quot;);
  widget.textContent = &quot;\u2194&quot;;
  cm.markText(Pos(0, 3), Pos(1, 0), {replacedWith: widget});
  cm.setSelection(Pos(0, 3), Pos(1, 0));
  var selElts = byClassName(cm.getWrapperElement(), &quot;CodeMirror-selected&quot;);
  for (var i = 0, w = 0; i &lt; selElts.length; i++)
    w += selElts[i].offsetWidth;
  is(w &gt; 0);
}, {value: &quot;one\ntwo&quot;});

testCM(&quot;randomCollapsedRanges&quot;, function(cm) {
  addDoc(cm, 20, 500);
  cm.operation(function() {
    for (var i = 0; i &lt; 200; i++) {
      var start = Pos(Math.floor(Math.random() * 500), Math.floor(Math.random() * 20));
      if (i % 4)
        try { cm.markText(start, Pos(start.line + 2, 1), {collapsed: true}); }
        catch(e) { if (!/overlapping/.test(String(e))) throw e; }
      else
        cm.markText(start, Pos(start.line, start.ch + 4), {&quot;className&quot;: &quot;foo&quot;});
    }
  });
});

testCM(&quot;hiddenLinesAutoUnfold&quot;, function(cm) {
  var range = foldLines(cm, 1, 3, true), cleared = 0;
  CodeMirror.on(range, &quot;clear&quot;, function() {cleared++;});
  cm.setCursor(Pos(3, 0));
  eq(cleared, 0);
  cm.execCommand(&quot;goCharLeft&quot;);
  eq(cleared, 1);
  range = foldLines(cm, 1, 3, true);
  CodeMirror.on(range, &quot;clear&quot;, function() {cleared++;});
  eqPos(cm.getCursor(), Pos(3, 0));
  cm.setCursor(Pos(0, 3));
  cm.execCommand(&quot;goCharRight&quot;);
  eq(cleared, 2);
}, {value: &quot;abc\ndef\nghi\njkl&quot;});

testCM(&quot;hiddenLinesSelectAll&quot;, function(cm) {  // Issue #484
  addDoc(cm, 4, 20);
  foldLines(cm, 0, 10);
  foldLines(cm, 11, 20);
  CodeMirror.commands.selectAll(cm);
  eqPos(cm.getCursor(true), Pos(10, 0));
  eqPos(cm.getCursor(false), Pos(10, 4));
});


testCM(&quot;everythingFolded&quot;, function(cm) {
  addDoc(cm, 2, 2);
  function enterPress() {
    cm.triggerOnKeyDown({type: &quot;keydown&quot;, keyCode: 13, preventDefault: function(){}, stopPropagation: function(){}});
  }
  var fold = foldLines(cm, 0, 2);
  enterPress();
  eq(cm.getValue(), &quot;xx\nxx&quot;);
  fold.clear();
  fold = foldLines(cm, 0, 2, true);
  eq(fold.find(), null);
  enterPress();
  eq(cm.getValue(), &quot;\nxx\nxx&quot;);
});

testCM(&quot;structuredFold&quot;, function(cm) {
  if (phantom) return;
  addDoc(cm, 4, 8);
  var range = cm.markText(Pos(1, 2), Pos(6, 2), {
    replacedWith: document.createTextNode(&quot;Q&quot;)
  });
  cm.setCursor(0, 3);
  CodeMirror.commands.goLineDown(cm);
  eqPos(cm.getCursor(), Pos(6, 2));
  CodeMirror.commands.goCharLeft(cm);
  eqPos(cm.getCursor(), Pos(1, 2));
  CodeMirror.commands.delCharAfter(cm);
  eq(cm.getValue(), &quot;xxxx\nxxxx\nxxxx&quot;);
  addDoc(cm, 4, 8);
  range = cm.markText(Pos(1, 2), Pos(6, 2), {
    replacedWith: document.createTextNode(&quot;M&quot;),
    clearOnEnter: true
  });
  var cleared = 0;
  CodeMirror.on(range, &quot;clear&quot;, function(){++cleared;});
  cm.setCursor(0, 3);
  CodeMirror.commands.goLineDown(cm);
  eqPos(cm.getCursor(), Pos(6, 2));
  CodeMirror.commands.goCharLeft(cm);
  eqPos(cm.getCursor(), Pos(6, 1));
  eq(cleared, 1);
  range.clear();
  eq(cleared, 1);
  range = cm.markText(Pos(1, 2), Pos(6, 2), {
    replacedWith: document.createTextNode(&quot;Q&quot;),
    clearOnEnter: true
  });
  range.clear();
  cm.setCursor(1, 2);
  CodeMirror.commands.goCharRight(cm);
  eqPos(cm.getCursor(), Pos(1, 3));
  range = cm.markText(Pos(2, 0), Pos(4, 4), {
    replacedWith: document.createTextNode(&quot;M&quot;)
  });
  cm.setCursor(1, 0);
  CodeMirror.commands.goLineDown(cm);
  eqPos(cm.getCursor(), Pos(2, 0));
}, null);

testCM(&quot;nestedFold&quot;, function(cm) {
  addDoc(cm, 10, 3);
  function fold(ll, cl, lr, cr) {
    return cm.markText(Pos(ll, cl), Pos(lr, cr), {collapsed: true});
  }
  var inner1 = fold(0, 6, 1, 3), inner2 = fold(0, 2, 1, 8), outer = fold(0, 1, 2, 3), inner0 = fold(0, 5, 0, 6);
  cm.setCursor(0, 1);
  CodeMirror.commands.goCharRight(cm);
  eqPos(cm.getCursor(), Pos(2, 3));
  inner0.clear();
  CodeMirror.commands.goCharLeft(cm);
  eqPos(cm.getCursor(), Pos(0, 1));
  outer.clear();
  CodeMirror.commands.goCharRight(cm);
  eqPos(cm.getCursor(), Pos(0, 2));
  CodeMirror.commands.goCharRight(cm);
  eqPos(cm.getCursor(), Pos(1, 8));
  inner2.clear();
  CodeMirror.commands.goCharLeft(cm);
  eqPos(cm.getCursor(), Pos(1, 7));
  cm.setCursor(0, 5);
  CodeMirror.commands.goCharRight(cm);
  eqPos(cm.getCursor(), Pos(0, 6));
  CodeMirror.commands.goCharRight(cm);
  eqPos(cm.getCursor(), Pos(1, 3));
});

testCM(&quot;badNestedFold&quot;, function(cm) {
  addDoc(cm, 4, 4);
  cm.markText(Pos(0, 2), Pos(3, 2), {collapsed: true});
  var caught;
  try {cm.markText(Pos(0, 1), Pos(0, 3), {collapsed: true});}
  catch(e) {caught = e;}
  is(caught instanceof Error, &quot;no error&quot;);
  is(/overlap/i.test(caught.message), &quot;wrong error&quot;);
});

testCM(&quot;nestedFoldOnSide&quot;, function(cm) {
  var m1 = cm.markText(Pos(0, 1), Pos(2, 1), {collapsed: true, inclusiveRight: true});
  var m2 = cm.markText(Pos(0, 1), Pos(0, 2), {collapsed: true});
  cm.markText(Pos(0, 1), Pos(0, 2), {collapsed: true}).clear();
  try { cm.markText(Pos(0, 1), Pos(0, 2), {collapsed: true, inclusiveLeft: true}); }
  catch(e) { var caught = e; }
  is(caught &amp;&amp; /overlap/i.test(caught.message));
  var m3 = cm.markText(Pos(2, 0), Pos(2, 1), {collapsed: true});
  var m4 = cm.markText(Pos(2, 0), Pos(2, 1), {collapse: true, inclusiveRight: true});
  m1.clear(); m4.clear();
  m1 = cm.markText(Pos(0, 1), Pos(2, 1), {collapsed: true});
  cm.markText(Pos(2, 0), Pos(2, 1), {collapsed: true}).clear();
  try { cm.markText(Pos(2, 0), Pos(2, 1), {collapsed: true, inclusiveRight: true}); }
  catch(e) { var caught = e; }
  is(caught &amp;&amp; /overlap/i.test(caught.message));
}, {value: &quot;ab\ncd\ef&quot;});

testCM(&quot;editInFold&quot;, function(cm) {
  addDoc(cm, 4, 6);
  var m = cm.markText(Pos(1, 2), Pos(3, 2), {collapsed: true});
  cm.replaceRange(&quot;&quot;, Pos(0, 0), Pos(1, 3));
  cm.replaceRange(&quot;&quot;, Pos(2, 1), Pos(3, 3));
  cm.replaceRange(&quot;a\nb\nc\nd&quot;, Pos(0, 1), Pos(1, 0));
  cm.cursorCoords(Pos(0, 0));
});

testCM(&quot;wrappingInlineWidget&quot;, function(cm) {
  cm.setSize(&quot;11em&quot;);
  var w = document.createElement(&quot;span&quot;);
  w.style.color = &quot;red&quot;;
  w.innerHTML = &quot;one two three four&quot;;
  cm.markText(Pos(0, 6), Pos(0, 9), {replacedWith: w});
  var cur0 = cm.cursorCoords(Pos(0, 0)), cur1 = cm.cursorCoords(Pos(0, 10));
  is(cur0.top &lt; cur1.top);
  is(cur0.bottom &lt; cur1.bottom);
  var curL = cm.cursorCoords(Pos(0, 6)), curR = cm.cursorCoords(Pos(0, 9));
  eq(curL.top, cur0.top);
  eq(curL.bottom, cur0.bottom);
  eq(curR.top, cur1.top);
  eq(curR.bottom, cur1.bottom);
  cm.replaceRange(&quot;&quot;, Pos(0, 9), Pos(0));
  curR = cm.cursorCoords(Pos(0, 9));
  if (phantom) return;
  eq(curR.top, cur1.top);
  eq(curR.bottom, cur1.bottom);
}, {value: &quot;1 2 3 xxx 4&quot;, lineWrapping: true});

testCM(&quot;showEmptyWidgetSpan&quot;, function(cm) {
  var marker = cm.markText(Pos(0, 2), Pos(0, 2), {
    clearWhenEmpty: false,
    replacedWith: document.createTextNode(&quot;X&quot;)
  });
  eq(cm.display.view[0].text.textContent, &quot;abXc&quot;);
}, {value: &quot;abc&quot;});

testCM(&quot;changedInlineWidget&quot;, function(cm) {
  cm.setSize(&quot;10em&quot;);
  var w = document.createElement(&quot;span&quot;);
  w.innerHTML = &quot;x&quot;;
  var m = cm.markText(Pos(0, 4), Pos(0, 5), {replacedWith: w});
  w.innerHTML = &quot;and now the widget is really really long all of a sudden and a scrollbar is needed&quot;;
  m.changed();
  var hScroll = byClassName(cm.getWrapperElement(), &quot;CodeMirror-hscrollbar&quot;)[0];
  is(hScroll.scrollWidth &gt; hScroll.clientWidth);
}, {value: &quot;hello there&quot;});

testCM(&quot;changedBookmark&quot;, function(cm) {
  cm.setSize(&quot;10em&quot;);
  var w = document.createElement(&quot;span&quot;);
  w.innerHTML = &quot;x&quot;;
  var m = cm.setBookmark(Pos(0, 4), {widget: w});
  w.innerHTML = &quot;and now the widget is really really long all of a sudden and a scrollbar is needed&quot;;
  m.changed();
  var hScroll = byClassName(cm.getWrapperElement(), &quot;CodeMirror-hscrollbar&quot;)[0];
  is(hScroll.scrollWidth &gt; hScroll.clientWidth);
}, {value: &quot;abcdefg&quot;});

testCM(&quot;inlineWidget&quot;, function(cm) {
  var w = cm.setBookmark(Pos(0, 2), {widget: document.createTextNode(&quot;uu&quot;)});
  cm.setCursor(0, 2);
  CodeMirror.commands.goLineDown(cm);
  eqPos(cm.getCursor(), Pos(1, 4));
  cm.setCursor(0, 2);
  cm.replaceSelection(&quot;hi&quot;);
  eqPos(w.find(), Pos(0, 2));
  cm.setCursor(0, 1);
  cm.replaceSelection(&quot;ay&quot;);
  eqPos(w.find(), Pos(0, 4));
  eq(cm.getLine(0), &quot;uayuhiuu&quot;);
}, {value: &quot;uuuu\nuuuuuu&quot;});

testCM(&quot;wrappingAndResizing&quot;, function(cm) {
  cm.setSize(null, &quot;auto&quot;);
  cm.setOption(&quot;lineWrapping&quot;, true);
  var wrap = cm.getWrapperElement(), h0 = wrap.offsetHeight;
  var doc = &quot;xxx xxx xxx xxx xxx&quot;;
  cm.setValue(doc);
  for (var step = 10, w = cm.charCoords(Pos(0, 18), &quot;div&quot;).right;; w += step) {
    cm.setSize(w);
    if (wrap.offsetHeight &lt;= h0 * (opera_lt10 ? 1.2 : 1.5)) {
      if (step == 10) { w -= 10; step = 1; }
      else break;
    }
  }
  // Ensure that putting the cursor at the end of the maximally long
  // line doesn&apos;t cause wrapping to happen.
  cm.setCursor(Pos(0, doc.length));
  eq(wrap.offsetHeight, h0);
  cm.replaceSelection(&quot;x&quot;);
  is(wrap.offsetHeight &gt; h0, &quot;wrapping happens&quot;);
  // Now add a max-height and, in a document consisting of
  // almost-wrapped lines, go over it so that a scrollbar appears.
  cm.setValue(doc + &quot;\n&quot; + doc + &quot;\n&quot;);
  cm.getScrollerElement().style.maxHeight = &quot;100px&quot;;
  cm.replaceRange(&quot;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n!\n&quot;, Pos(2, 0));
  forEach([Pos(0, doc.length), Pos(0, doc.length - 1),
           Pos(0, 0), Pos(1, doc.length), Pos(1, doc.length - 1)],
          function(pos) {
    var coords = cm.charCoords(pos);
    eqPos(pos, cm.coordsChar({left: coords.left + 2, top: coords.top + 5}));
  });
}, null, ie_lt8);

testCM(&quot;measureEndOfLine&quot;, function(cm) {
  if (phantom) return;
  cm.setSize(null, &quot;auto&quot;);
  var inner = byClassName(cm.getWrapperElement(), &quot;CodeMirror-lines&quot;)[0].firstChild;
  var lh = inner.offsetHeight;
  for (var step = 10, w = cm.charCoords(Pos(0, 7), &quot;div&quot;).right;; w += step) {
    cm.setSize(w);
    if (inner.offsetHeight &lt; 2.5 * lh) {
      if (step == 10) { w -= 10; step = 1; }
      else break;
    }
  }
  cm.setValue(cm.getValue() + &quot;\n\n&quot;);
  var endPos = cm.charCoords(Pos(0, 18), &quot;local&quot;);
  is(endPos.top &gt; lh * .8, &quot;not at top&quot;);
  is(endPos.left &gt; w - 20, &quot;not at right&quot;);
  endPos = cm.charCoords(Pos(0, 18));
  eqPos(cm.coordsChar({left: endPos.left, top: endPos.top + 5}), Pos(0, 18));
}, {mode: &quot;text/html&quot;, value: &quot;&lt;!-- foo barrr --&gt;&quot;, lineWrapping: true}, ie_lt8 || opera_lt10);

testCM(&quot;measureWrappedEndOfLine&quot;, function(cm) {
  if (phantom) return;
  cm.setSize(null, &quot;auto&quot;);
  var inner = byClassName(cm.getWrapperElement(), &quot;CodeMirror-lines&quot;)[0].firstChild;
  var lh = inner.offsetHeight;
  for (var step = 10, w = cm.charCoords(Pos(0, 7), &quot;div&quot;).right;; w += step) {
    cm.setSize(w);
    if (inner.offsetHeight &lt; 2.5 * lh) {
      if (step == 10) { w -= 10; step = 1; }
      else break;
    }
  }
  var endPos = cm.charCoords(Pos(0, 12)); // Next-to-last since last would wrap (#1862)
  endPos.left += w; // Add width of editor just to be sure that we are behind last character
  eqPos(cm.coordsChar(endPos), Pos(0, 13));
}, {mode: &quot;text/html&quot;, value: &quot;0123456789abcde0123456789&quot;, lineWrapping: true}, ie_lt8 || opera_lt10);

testCM(&quot;scrollVerticallyAndHorizontally&quot;, function(cm) {
  if (cm.getOption(&quot;inputStyle&quot;) != &quot;textarea&quot;) return;
  cm.setSize(100, 100);
  addDoc(cm, 40, 40);
  cm.setCursor(39);
  var wrap = cm.getWrapperElement(), bar = byClassName(wrap, &quot;CodeMirror-vscrollbar&quot;)[0];
  is(bar.offsetHeight &lt; wrap.offsetHeight, &quot;vertical scrollbar limited by horizontal one&quot;);
  var cursorBox = byClassName(wrap, &quot;CodeMirror-cursor&quot;)[0].getBoundingClientRect();
  var editorBox = wrap.getBoundingClientRect();
  is(cursorBox.bottom &lt; editorBox.top + cm.getScrollerElement().clientHeight,
     &quot;bottom line visible&quot;);
}, {lineNumbers: true});

testCM(&quot;moveVstuck&quot;, function(cm) {
  var lines = byClassName(cm.getWrapperElement(), &quot;CodeMirror-lines&quot;)[0].firstChild, h0 = lines.offsetHeight;
  var val = &quot;fooooooooooooooooooooooooo baaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaar\n&quot;;
  cm.setValue(val);
  for (var w = cm.charCoords(Pos(0, 26), &quot;div&quot;).right * 2.8;; w += 5) {
    cm.setSize(w);
    if (lines.offsetHeight &lt;= 3.5 * h0) break;
  }
  cm.setCursor(Pos(0, val.length - 1));
  cm.moveV(-1, &quot;line&quot;);
  eqPos(cm.getCursor(), Pos(0, 26));
}, {lineWrapping: true}, ie_lt8 || opera_lt10);

testCM(&quot;collapseOnMove&quot;, function(cm) {
  cm.setSelection(Pos(0, 1), Pos(2, 4));
  cm.execCommand(&quot;goLineUp&quot;);
  is(!cm.somethingSelected());
  eqPos(cm.getCursor(), Pos(0, 1));
  cm.setSelection(Pos(0, 1), Pos(2, 4));
  cm.execCommand(&quot;goPageDown&quot;);
  is(!cm.somethingSelected());
  eqPos(cm.getCursor(), Pos(2, 4));
  cm.execCommand(&quot;goLineUp&quot;);
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(0, 4));
  cm.setSelection(Pos(0, 1), Pos(2, 4));
  cm.execCommand(&quot;goCharLeft&quot;);
  is(!cm.somethingSelected());
  eqPos(cm.getCursor(), Pos(0, 1));
}, {value: &quot;aaaaa\nb\nccccc&quot;});

testCM(&quot;clickTab&quot;, function(cm) {
  var p0 = cm.charCoords(Pos(0, 0));
  eqPos(cm.coordsChar({left: p0.left + 5, top: p0.top + 5}), Pos(0, 0));
  eqPos(cm.coordsChar({left: p0.right - 5, top: p0.top + 5}), Pos(0, 1));
}, {value: &quot;\t\n\n&quot;, lineWrapping: true, tabSize: 8});

testCM(&quot;verticalScroll&quot;, function(cm) {
  cm.setSize(100, 200);
  cm.setValue(&quot;foo\nbar\nbaz\n&quot;);
  var sc = cm.getScrollerElement(), baseWidth = sc.scrollWidth;
  cm.replaceRange(&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah&quot;, Pos(0, 0), Pos(0));
  is(sc.scrollWidth &gt; baseWidth, &quot;scrollbar present&quot;);
  cm.replaceRange(&quot;foo&quot;, Pos(0, 0), Pos(0));
  if (!phantom) eq(sc.scrollWidth, baseWidth, &quot;scrollbar gone&quot;);
  cm.replaceRange(&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah&quot;, Pos(0, 0), Pos(0));
  cm.replaceRange(&quot;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbh&quot;, Pos(1, 0), Pos(1));
  is(sc.scrollWidth &gt; baseWidth, &quot;present again&quot;);
  var curWidth = sc.scrollWidth;
  cm.replaceRange(&quot;foo&quot;, Pos(0, 0), Pos(0));
  is(sc.scrollWidth &lt; curWidth, &quot;scrollbar smaller&quot;);
  is(sc.scrollWidth &gt; baseWidth, &quot;but still present&quot;);
});

testCM(&quot;extraKeys&quot;, function(cm) {
  var outcome;
  function fakeKey(expected, code, props) {
    if (typeof code == &quot;string&quot;) code = code.charCodeAt(0);
    var e = {type: &quot;keydown&quot;, keyCode: code, preventDefault: function(){}, stopPropagation: function(){}};
    if (props) for (var n in props) e[n] = props[n];
    outcome = null;
    cm.triggerOnKeyDown(e);
    eq(outcome, expected);
  }
  CodeMirror.commands.testCommand = function() {outcome = &quot;tc&quot;;};
  CodeMirror.commands.goTestCommand = function() {outcome = &quot;gtc&quot;;};
  cm.setOption(&quot;extraKeys&quot;, {&quot;Shift-X&quot;: function() {outcome = &quot;sx&quot;;},
                             &quot;X&quot;: function() {outcome = &quot;x&quot;;},
                             &quot;Ctrl-Alt-U&quot;: function() {outcome = &quot;cau&quot;;},
                             &quot;End&quot;: &quot;testCommand&quot;,
                             &quot;Home&quot;: &quot;goTestCommand&quot;,
                             &quot;Tab&quot;: false});
  fakeKey(null, &quot;U&quot;);
  fakeKey(&quot;cau&quot;, &quot;U&quot;, {ctrlKey: true, altKey: true});
  fakeKey(null, &quot;U&quot;, {shiftKey: true, ctrlKey: true, altKey: true});
  fakeKey(&quot;x&quot;, &quot;X&quot;);
  fakeKey(&quot;sx&quot;, &quot;X&quot;, {shiftKey: true});
  fakeKey(&quot;tc&quot;, 35);
  fakeKey(null, 35, {shiftKey: true});
  fakeKey(&quot;gtc&quot;, 36);
  fakeKey(&quot;gtc&quot;, 36, {shiftKey: true});
  fakeKey(null, 9);
}, null, window.opera &amp;&amp; mac);

testCM(&quot;wordMovementCommands&quot;, function(cm) {
  cm.execCommand(&quot;goWordLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
  cm.execCommand(&quot;goWordRight&quot;); cm.execCommand(&quot;goWordRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 7));
  cm.execCommand(&quot;goWordLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 5));
  cm.execCommand(&quot;goWordRight&quot;); cm.execCommand(&quot;goWordRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 12));
  cm.execCommand(&quot;goWordLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 9));
  cm.execCommand(&quot;goWordRight&quot;); cm.execCommand(&quot;goWordRight&quot;); cm.execCommand(&quot;goWordRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 24));
  cm.execCommand(&quot;goWordRight&quot;); cm.execCommand(&quot;goWordRight&quot;);
  eqPos(cm.getCursor(), Pos(1, 9));
  cm.execCommand(&quot;goWordRight&quot;);
  eqPos(cm.getCursor(), Pos(1, 13));
  cm.execCommand(&quot;goWordRight&quot;); cm.execCommand(&quot;goWordRight&quot;);
  eqPos(cm.getCursor(), Pos(2, 0));
}, {value: &quot;this is (the) firstline.\na foo12\u00e9\u00f8\u00d7bar\n&quot;});

testCM(&quot;groupMovementCommands&quot;, function(cm) {
  cm.execCommand(&quot;goGroupLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
  cm.execCommand(&quot;goGroupRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 4));
  cm.execCommand(&quot;goGroupRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 7));
  cm.execCommand(&quot;goGroupRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 10));
  cm.execCommand(&quot;goGroupLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 7));
  cm.execCommand(&quot;goGroupRight&quot;); cm.execCommand(&quot;goGroupRight&quot;); cm.execCommand(&quot;goGroupRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 15));
  cm.setCursor(Pos(0, 17));
  cm.execCommand(&quot;goGroupLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 16));
  cm.execCommand(&quot;goGroupLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 14));
  cm.execCommand(&quot;goGroupRight&quot;); cm.execCommand(&quot;goGroupRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 20));
  cm.execCommand(&quot;goGroupRight&quot;);
  eqPos(cm.getCursor(), Pos(1, 0));
  cm.execCommand(&quot;goGroupRight&quot;);
  eqPos(cm.getCursor(), Pos(1, 2));
  cm.execCommand(&quot;goGroupRight&quot;);
  eqPos(cm.getCursor(), Pos(1, 5));
  cm.execCommand(&quot;goGroupLeft&quot;); cm.execCommand(&quot;goGroupLeft&quot;);
  eqPos(cm.getCursor(), Pos(1, 0));
  cm.execCommand(&quot;goGroupLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 20));
  cm.execCommand(&quot;goGroupLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 16));
}, {value: &quot;booo ba---quux. ffff\n  abc d&quot;});

testCM(&quot;groupsAndWhitespace&quot;, function(cm) {
  var positions = [Pos(0, 0), Pos(0, 2), Pos(0, 5), Pos(0, 9), Pos(0, 11),
                   Pos(1, 0), Pos(1, 2), Pos(1, 5)];
  for (var i = 1; i &lt; positions.length; i++) {
    cm.execCommand(&quot;goGroupRight&quot;);
    eqPos(cm.getCursor(), positions[i]);
  }
  for (var i = positions.length - 2; i &gt;= 0; i--) {
    cm.execCommand(&quot;goGroupLeft&quot;);
    eqPos(cm.getCursor(), i == 2 ? Pos(0, 6) : positions[i]);
  }
}, {value: &quot;  foo +++  \n  bar&quot;});

testCM(&quot;charMovementCommands&quot;, function(cm) {
  cm.execCommand(&quot;goCharLeft&quot;); cm.execCommand(&quot;goColumnLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
  cm.execCommand(&quot;goCharRight&quot;); cm.execCommand(&quot;goCharRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 2));
  cm.setCursor(Pos(1, 0));
  cm.execCommand(&quot;goColumnLeft&quot;);
  eqPos(cm.getCursor(), Pos(1, 0));
  cm.execCommand(&quot;goCharLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 5));
  cm.execCommand(&quot;goColumnRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 5));
  cm.execCommand(&quot;goCharRight&quot;);
  eqPos(cm.getCursor(), Pos(1, 0));
  cm.execCommand(&quot;goLineEnd&quot;);
  eqPos(cm.getCursor(), Pos(1, 5));
  cm.execCommand(&quot;goLineStartSmart&quot;);
  eqPos(cm.getCursor(), Pos(1, 1));
  cm.execCommand(&quot;goLineStartSmart&quot;);
  eqPos(cm.getCursor(), Pos(1, 0));
  cm.setCursor(Pos(2, 0));
  cm.execCommand(&quot;goCharRight&quot;); cm.execCommand(&quot;goColumnRight&quot;);
  eqPos(cm.getCursor(), Pos(2, 0));
}, {value: &quot;line1\n ine2\n&quot;});

testCM(&quot;verticalMovementCommands&quot;, function(cm) {
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
  cm.execCommand(&quot;goLineDown&quot;);
  if (!phantom) // This fails in PhantomJS, though not in a real Webkit
    eqPos(cm.getCursor(), Pos(1, 0));
  cm.setCursor(Pos(1, 12));
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(2, 5));
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(3, 0));
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(2, 5));
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(1, 12));
  cm.execCommand(&quot;goPageDown&quot;);
  eqPos(cm.getCursor(), Pos(5, 0));
  cm.execCommand(&quot;goPageDown&quot;); cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(5, 0));
  cm.execCommand(&quot;goPageUp&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
}, {value: &quot;line1\nlong long line2\nline3\n\nline5\n&quot;});

testCM(&quot;verticalMovementCommandsWrapping&quot;, function(cm) {
  cm.setSize(120);
  cm.setCursor(Pos(0, 5));
  cm.execCommand(&quot;goLineDown&quot;);
  eq(cm.getCursor().line, 0);
  is(cm.getCursor().ch &gt; 5, &quot;moved beyond wrap&quot;);
  for (var i = 0; ; ++i) {
    is(i &lt; 20, &quot;no endless loop&quot;);
    cm.execCommand(&quot;goLineDown&quot;);
    var cur = cm.getCursor();
    if (cur.line == 1) eq(cur.ch, 5);
    if (cur.line == 2) { eq(cur.ch, 1); break; }
  }
}, {value: &quot;a very long line that wraps around somehow so that we can test cursor movement\nshortone\nk&quot;,
    lineWrapping: true});

testCM(&quot;verticalMovementCommandsSingleLine&quot;, function(cm) {
  cm.display.wrapper.style.height = &quot;auto&quot;;
  cm.refresh();
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(0, 11));
  cm.setCursor(Pos(0, 5));
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(0, 11));
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(0, 11));
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
  cm.execCommand(&quot;goPageDown&quot;);
  eqPos(cm.getCursor(), Pos(0, 11));
  cm.execCommand(&quot;goPageDown&quot;); cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(0, 11));
  cm.execCommand(&quot;goPageUp&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
  cm.setCursor(Pos(0, 5));
  cm.execCommand(&quot;goPageUp&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
  cm.setCursor(Pos(0, 5));
  cm.execCommand(&quot;goPageDown&quot;);
  eqPos(cm.getCursor(), Pos(0, 11));
}, {value: &quot;single line&quot;});


testCM(&quot;rtlMovement&quot;, function(cm) {
  if (cm.getOption(&quot;inputStyle&quot;) != &quot;textarea&quot;) return;
  forEach([&quot;&#x62E;&#x62D;&#x62C;&quot;, &quot;&#x62E;&#x62D;abc&#x62E;&#x62D;&#x62C;&quot;, &quot;ab&#x62E;&#x62D;&#x62E;&#x62D;&#x62C;cd&quot;, &quot;ab&#x62E;de&quot;, &quot;ab&#x62E;&#x62D;2342&#x62E;1&#x62D;&#x62C;&quot;, &quot;&#x62E;1&#x62D;2&#x62E;&#x62D;3&#x62D;x&#x62C;&quot;,
           &quot;&#x62E;&#x62D;cd&quot;, &quot;1&#x62E;&#x62D;cd&quot;, &quot;abcde&#x62D;1&#x62C;&quot;, &quot;&#x62E;&#x645;&#x631;&#x62D;&#x628;&#x647;&#x627; &#x645;&#x647;&#x627;!&quot;, &quot;foobar&#x631;&quot;, &quot;&#x62E; &#x629; &#x642;&quot;,
           &quot;&lt;img src=\&quot;/&#x5D1;&#x5D3;&#x5D9;&#x5E7;&#x5D4;3.jpg\&quot;&gt;&quot;, &quot;&#x64A;&#x62A;&#x645; &#x627;&#x644;&#x633;&#x62D;&#x628; &#x641;&#x64A; 05 &#x641;&#x628;&#x631;&#x627;&#x64A;&#x631; 2014&quot;], function(line) {
    var inv = line.charCodeAt(0) &gt; 128;
    cm.setValue(line + &quot;\n&quot;); cm.execCommand(inv ? &quot;goLineEnd&quot; : &quot;goLineStart&quot;);
    var cursors = byClassName(cm.getWrapperElement(), &quot;CodeMirror-cursors&quot;)[0];
    var cursor = cursors.firstChild;
    var prevX = cursor.offsetLeft, prevY = cursor.offsetTop;
    for (var i = 0; i &lt;= line.length; ++i) {
      cm.execCommand(&quot;goCharRight&quot;);
      cursor = cursors.firstChild;
      if (i == line.length) is(cursor.offsetTop &gt; prevY, &quot;next line&quot;);
      else is(cursor.offsetLeft &gt; prevX, &quot;moved right&quot;);
      prevX = cursor.offsetLeft; prevY = cursor.offsetTop;
    }
    cm.setCursor(0, 0); cm.execCommand(inv ? &quot;goLineStart&quot; : &quot;goLineEnd&quot;);
    prevX = cursors.firstChild.offsetLeft;
    for (var i = 0; i &lt; line.length; ++i) {
      cm.execCommand(&quot;goCharLeft&quot;);
      cursor = cursors.firstChild;
      is(cursor.offsetLeft &lt; prevX, &quot;moved left&quot;);
      prevX = cursor.offsetLeft;
    }
  });
}, null, ie_lt9);

// Verify that updating a line clears its bidi ordering
testCM(&quot;bidiUpdate&quot;, function(cm) {
  cm.setCursor(Pos(0, 2));
  cm.replaceSelection(&quot;&#x62E;&#x62D;&#x62C;&quot;, &quot;start&quot;);
  cm.execCommand(&quot;goCharRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 4));
}, {value: &quot;abcd\n&quot;});

testCM(&quot;movebyTextUnit&quot;, function(cm) {
  cm.setValue(&quot;&#x5D1;&#x5B0;&#x5BC;&#x5E8;&#x5B5;&#x5D0;&#x5E9;&#x5B4;\ne&#x301;e&#x301;e&#x301;&#x301;\n&quot;);
  cm.execCommand(&quot;goLineEnd&quot;);
  for (var i = 0; i &lt; 4; ++i) cm.execCommand(&quot;goCharRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
  cm.execCommand(&quot;goCharRight&quot;);
  eqPos(cm.getCursor(), Pos(1, 0));
  cm.execCommand(&quot;goCharRight&quot;);
  cm.execCommand(&quot;goCharRight&quot;);
  eqPos(cm.getCursor(), Pos(1, 4));
  cm.execCommand(&quot;goCharRight&quot;);
  eqPos(cm.getCursor(), Pos(1, 7));
});

testCM(&quot;lineChangeEvents&quot;, function(cm) {
  addDoc(cm, 3, 5);
  var log = [], want = [&quot;ch 0&quot;, &quot;ch 1&quot;, &quot;del 2&quot;, &quot;ch 0&quot;, &quot;ch 0&quot;, &quot;del 1&quot;, &quot;del 3&quot;, &quot;del 4&quot;];
  for (var i = 0; i &lt; 5; ++i) {
    CodeMirror.on(cm.getLineHandle(i), &quot;delete&quot;, function(i) {
      return function() {log.push(&quot;del &quot; + i);};
    }(i));
    CodeMirror.on(cm.getLineHandle(i), &quot;change&quot;, function(i) {
      return function() {log.push(&quot;ch &quot; + i);};
    }(i));
  }
  cm.replaceRange(&quot;x&quot;, Pos(0, 1));
  cm.replaceRange(&quot;xy&quot;, Pos(1, 1), Pos(2));
  cm.replaceRange(&quot;foo\nbar&quot;, Pos(0, 1));
  cm.replaceRange(&quot;&quot;, Pos(0, 0), Pos(cm.lineCount()));
  eq(log.length, want.length, &quot;same length&quot;);
  for (var i = 0; i &lt; log.length; ++i)
    eq(log[i], want[i]);
});

testCM(&quot;scrollEntirelyToRight&quot;, function(cm) {
  if (phantom || cm.getOption(&quot;inputStyle&quot;) != &quot;textarea&quot;) return;
  addDoc(cm, 500, 2);
  cm.setCursor(Pos(0, 500));
  var wrap = cm.getWrapperElement(), cur = byClassName(wrap, &quot;CodeMirror-cursor&quot;)[0];
  is(wrap.getBoundingClientRect().right &gt; cur.getBoundingClientRect().left);
});

testCM(&quot;lineWidgets&quot;, function(cm) {
  addDoc(cm, 500, 3);
  var last = cm.charCoords(Pos(2, 0));
  var node = document.createElement(&quot;div&quot;);
  node.innerHTML = &quot;hi&quot;;
  var widget = cm.addLineWidget(1, node);
  is(last.top &lt; cm.charCoords(Pos(2, 0)).top, &quot;took up space&quot;);
  cm.setCursor(Pos(1, 1));
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(2, 1));
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(1, 1));
});

testCM(&quot;lineWidgetFocus&quot;, function(cm) {
  var place = document.getElementById(&quot;testground&quot;);
  place.className = &quot;offscreen&quot;;
  try {
    addDoc(cm, 500, 10);
    var node = document.createElement(&quot;input&quot;);
    var widget = cm.addLineWidget(1, node);
    node.focus();
    eq(document.activeElement, node);
    cm.replaceRange(&quot;new stuff&quot;, Pos(1, 0));
    eq(document.activeElement, node);
  } finally {
    place.className = &quot;&quot;;
  }
});

testCM(&quot;lineWidgetCautiousRedraw&quot;, function(cm) {
  var node = document.createElement(&quot;div&quot;);
  node.innerHTML = &quot;hahah&quot;;
  var w = cm.addLineWidget(0, node);
  var redrawn = false;
  w.on(&quot;redraw&quot;, function() { redrawn = true; });
  cm.replaceSelection(&quot;0&quot;);
  is(!redrawn);
}, {value: &quot;123\n456&quot;});


var knownScrollbarWidth;
function scrollbarWidth(measure) {
  if (knownScrollbarWidth != null) return knownScrollbarWidth;
  var div = document.createElement(&apos;div&apos;);
  div.style.cssText = &quot;width: 50px; height: 50px; overflow-x: scroll&quot;;
  document.body.appendChild(div);
  knownScrollbarWidth = div.offsetHeight - div.clientHeight;
  document.body.removeChild(div);
  return knownScrollbarWidth || 0;
}

testCM(&quot;lineWidgetChanged&quot;, function(cm) {
  addDoc(cm, 2, 300);
  var halfScrollbarWidth = scrollbarWidth(cm.display.measure)/2;
  cm.setOption(&apos;lineNumbers&apos;, true);
  cm.setSize(600, cm.defaultTextHeight() * 50);
  cm.scrollTo(null, cm.heightAtLine(125, &quot;local&quot;));

  var expectedWidgetHeight = 60;
  var expectedLinesInWidget = 3;
  function w() {
    var node = document.createElement(&quot;div&quot;);
    // we use these children with just under half width of the line to check measurements are made with correct width
    // when placed in the measure div.
    // If the widget is measured at a width much narrower than it is displayed at, the underHalf children will span two lines and break the test.
    // If the widget is measured at a width much wider than it is displayed at, the overHalf children will combine and break the test.
    // Note that this test only checks widgets where coverGutter is true, because these require extra styling to get the width right.
    // It may also be worthwhile to check this for non-coverGutter widgets.
    // Visually:
    // Good:
    // | ------------- display width ------------- |
    // | ------- widget-width when measured ------ |
    // | | -- under-half -- | | -- under-half -- | |
    // | | --- over-half --- |                     |
    // | | --- over-half --- |                     |
    // Height: measured as 3 lines, same as it will be when actually displayed

    // Bad (too narrow):
    // | ------------- display width ------------- |
    // | ------ widget-width when measured ----- |  &lt; -- uh oh
    // | | -- under-half -- |                    |
    // | | -- under-half -- |                    |  &lt; -- when measured, shoved to next line
    // | | --- over-half --- |                   |
    // | | --- over-half --- |                   |
    // Height: measured as 4 lines, more than expected . Will be displayed as 3 lines!

    // Bad (too wide):
    // | ------------- display width ------------- |
    // | -------- widget-width when measured ------- | &lt; -- uh oh
    // | | -- under-half -- | | -- under-half -- |   |
    // | | --- over-half --- | | --- over-half --- | | &lt; -- when measured, combined on one line
    // Height: measured as 2 lines, less than expected. Will be displayed as 3 lines!

    var barelyUnderHalfWidthHtml = &apos;&lt;div style=&quot;display: inline-block; height: 1px; width: &apos;+(285 - halfScrollbarWidth)+&apos;px;&quot;&gt;&lt;/div&gt;&apos;;
    var barelyOverHalfWidthHtml = &apos;&lt;div style=&quot;display: inline-block; height: 1px; width: &apos;+(305 - halfScrollbarWidth)+&apos;px;&quot;&gt;&lt;/div&gt;&apos;;
    node.innerHTML = new Array(3).join(barelyUnderHalfWidthHtml) + new Array(3).join(barelyOverHalfWidthHtml);
    node.style.cssText = &quot;background: yellow;font-size:0;line-height: &quot; + (expectedWidgetHeight/expectedLinesInWidget) + &quot;px;&quot;;
    return node;
  }
  var info0 = cm.getScrollInfo();
  var w0 = cm.addLineWidget(0, w(), { coverGutter: true });
  var w150 = cm.addLineWidget(150, w(), { coverGutter: true });
  var w300 = cm.addLineWidget(300, w(), { coverGutter: true });
  var info1 = cm.getScrollInfo();
  eq(info0.height + (3 * expectedWidgetHeight), info1.height);
  eq(info0.top + expectedWidgetHeight, info1.top);
  expectedWidgetHeight = 12;
  w0.node.style.lineHeight = w150.node.style.lineHeight = w300.node.style.lineHeight = (expectedWidgetHeight/expectedLinesInWidget) + &quot;px&quot;;
  w0.changed(); w150.changed(); w300.changed();
  var info2 = cm.getScrollInfo();
  eq(info0.height + (3 * expectedWidgetHeight), info2.height);
  eq(info0.top + expectedWidgetHeight, info2.top);
});

testCM(&quot;getLineNumber&quot;, function(cm) {
  addDoc(cm, 2, 20);
  var h1 = cm.getLineHandle(1);
  eq(cm.getLineNumber(h1), 1);
  cm.replaceRange(&quot;hi\nbye\n&quot;, Pos(0, 0));
  eq(cm.getLineNumber(h1), 3);
  cm.setValue(&quot;&quot;);
  eq(cm.getLineNumber(h1), null);
});

testCM(&quot;jumpTheGap&quot;, function(cm) {
  if (phantom) return;
  var longLine = &quot;abcdef ghiklmnop qrstuvw xyz &quot;;
  longLine += longLine; longLine += longLine; longLine += longLine;
  cm.replaceRange(longLine, Pos(2, 0), Pos(2));
  cm.setSize(&quot;200px&quot;, null);
  cm.getWrapperElement().style.lineHeight = 2;
  cm.refresh();
  cm.setCursor(Pos(0, 1));
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(1, 1));
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(2, 1));
  cm.execCommand(&quot;goLineDown&quot;);
  eq(cm.getCursor().line, 2);
  is(cm.getCursor().ch &gt; 1);
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(2, 1));
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(1, 1));
  var node = document.createElement(&quot;div&quot;);
  node.innerHTML = &quot;hi&quot;; node.style.height = &quot;30px&quot;;
  cm.addLineWidget(0, node);
  cm.addLineWidget(1, node.cloneNode(true), {above: true});
  cm.setCursor(Pos(0, 2));
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(1, 2));
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(0, 2));
}, {lineWrapping: true, value: &quot;abc\ndef\nghi\njkl\n&quot;});

testCM(&quot;addLineClass&quot;, function(cm) {
  function cls(line, text, bg, wrap, gutter) {
    var i = cm.lineInfo(line);
    eq(i.textClass, text);
    eq(i.bgClass, bg);
    eq(i.wrapClass, wrap);
    if (typeof i.handle.gutterClass !== &apos;undefined&apos;) {
        eq(i.handle.gutterClass, gutter);
    }
  }
  cm.addLineClass(0, &quot;text&quot;, &quot;foo&quot;);
  cm.addLineClass(0, &quot;text&quot;, &quot;bar&quot;);
  cm.addLineClass(1, &quot;background&quot;, &quot;baz&quot;);
  cm.addLineClass(1, &quot;wrap&quot;, &quot;foo&quot;);
  cm.addLineClass(1, &quot;gutter&quot;, &quot;gutter-class&quot;);
  cls(0, &quot;foo bar&quot;, null, null, null);
  cls(1, null, &quot;baz&quot;, &quot;foo&quot;, &quot;gutter-class&quot;);
  var lines = cm.display.lineDiv;
  eq(byClassName(lines, &quot;foo&quot;).length, 2);
  eq(byClassName(lines, &quot;bar&quot;).length, 1);
  eq(byClassName(lines, &quot;baz&quot;).length, 1);
  eq(byClassName(lines, &quot;gutter-class&quot;).length, 2); // Gutter classes are reflected in 2 nodes
  cm.removeLineClass(0, &quot;text&quot;, &quot;foo&quot;);
  cls(0, &quot;bar&quot;, null, null, null);
  cm.removeLineClass(0, &quot;text&quot;, &quot;foo&quot;);
  cls(0, &quot;bar&quot;, null, null, null);
  cm.removeLineClass(0, &quot;text&quot;, &quot;bar&quot;);
  cls(0, null, null, null);

  cm.addLineClass(1, &quot;wrap&quot;, &quot;quux&quot;);
  cls(1, null, &quot;baz&quot;, &quot;foo quux&quot;, &quot;gutter-class&quot;);
  cm.removeLineClass(1, &quot;wrap&quot;);
  cls(1, null, &quot;baz&quot;, null, &quot;gutter-class&quot;);
  cm.removeLineClass(1, &quot;gutter&quot;, &quot;gutter-class&quot;);
  eq(byClassName(lines, &quot;gutter-class&quot;).length, 0);
  cls(1, null, &quot;baz&quot;, null, null);

  cm.addLineClass(1, &quot;gutter&quot;, &quot;gutter-class&quot;);
  cls(1, null, &quot;baz&quot;, null, &quot;gutter-class&quot;);
  cm.removeLineClass(1, &quot;gutter&quot;, &quot;gutter-class&quot;);
  cls(1, null, &quot;baz&quot;, null, null);

}, {value: &quot;hohoho\n&quot;, lineNumbers: true});

testCM(&quot;atomicMarker&quot;, function(cm) {
  addDoc(cm, 10, 10);
  function atom(ll, cl, lr, cr, li, ri) {
    return cm.markText(Pos(ll, cl), Pos(lr, cr),
                       {atomic: true, inclusiveLeft: li, inclusiveRight: ri});
  }
  var m = atom(0, 1, 0, 5);
  cm.setCursor(Pos(0, 1));
  cm.execCommand(&quot;goCharRight&quot;);
  eqPos(cm.getCursor(), Pos(0, 5));
  cm.execCommand(&quot;goCharLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 1));
  m.clear();
  m = atom(0, 0, 0, 5, true);
  eqPos(cm.getCursor(), Pos(0, 5), &quot;pushed out&quot;);
  cm.execCommand(&quot;goCharLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 5));
  m.clear();
  m = atom(8, 4, 9, 10, false, true);
  cm.setCursor(Pos(9, 8));
  eqPos(cm.getCursor(), Pos(8, 4), &quot;set&quot;);
  cm.execCommand(&quot;goCharRight&quot;);
  eqPos(cm.getCursor(), Pos(8, 4), &quot;char right&quot;);
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(8, 4), &quot;line down&quot;);
  cm.execCommand(&quot;goCharLeft&quot;);
  eqPos(cm.getCursor(), Pos(8, 3));
  m.clear();
  m = atom(1, 1, 3, 8);
  cm.setCursor(Pos(0, 0));
  cm.setCursor(Pos(2, 0));
  eqPos(cm.getCursor(), Pos(3, 8));
  cm.execCommand(&quot;goCharLeft&quot;);
  eqPos(cm.getCursor(), Pos(1, 1));
  cm.execCommand(&quot;goCharRight&quot;);
  eqPos(cm.getCursor(), Pos(3, 8));
  cm.execCommand(&quot;goLineUp&quot;);
  eqPos(cm.getCursor(), Pos(1, 1));
  cm.execCommand(&quot;goLineDown&quot;);
  eqPos(cm.getCursor(), Pos(3, 8));
  cm.execCommand(&quot;delCharBefore&quot;);
  eq(cm.getValue().length, 80, &quot;del chunk&quot;);
  m = atom(3, 0, 5, 5);
  cm.setCursor(Pos(3, 0));
  cm.execCommand(&quot;delWordAfter&quot;);
  eq(cm.getValue().length, 53, &quot;del chunk&quot;);
});

testCM(&quot;selectionBias&quot;, function(cm) {
  cm.markText(Pos(0, 1), Pos(0, 3), {atomic: true});
  cm.setCursor(Pos(0, 2));
  eqPos(cm.getCursor(), Pos(0, 1));
  cm.setCursor(Pos(0, 2));
  eqPos(cm.getCursor(), Pos(0, 3));
  cm.setCursor(Pos(0, 2));
  eqPos(cm.getCursor(), Pos(0, 1));
  cm.setCursor(Pos(0, 2), null, {bias: -1});
  eqPos(cm.getCursor(), Pos(0, 1));
  cm.setCursor(Pos(0, 4));
  cm.setCursor(Pos(0, 2), null, {bias: 1});
  eqPos(cm.getCursor(), Pos(0, 3));
}, {value: &quot;12345&quot;});

testCM(&quot;selectionHomeEnd&quot;, function(cm) {
  cm.markText(Pos(1, 0), Pos(1, 1), {atomic: true, inclusiveLeft: true});
  cm.markText(Pos(1, 3), Pos(1, 4), {atomic: true, inclusiveRight: true});
  cm.setCursor(Pos(1, 2));
  cm.execCommand(&quot;goLineStart&quot;);
  eqPos(cm.getCursor(), Pos(1, 1));
  cm.execCommand(&quot;goLineEnd&quot;);
  eqPos(cm.getCursor(), Pos(1, 3));
}, {value: &quot;ab\ncdef\ngh&quot;});

testCM(&quot;readOnlyMarker&quot;, function(cm) {
  function mark(ll, cl, lr, cr, at) {
    return cm.markText(Pos(ll, cl), Pos(lr, cr),
                       {readOnly: true, atomic: at});
  }
  var m = mark(0, 1, 0, 4);
  cm.setCursor(Pos(0, 2));
  cm.replaceSelection(&quot;hi&quot;, &quot;end&quot;);
  eqPos(cm.getCursor(), Pos(0, 2));
  eq(cm.getLine(0), &quot;abcde&quot;);
  cm.execCommand(&quot;selectAll&quot;);
  cm.replaceSelection(&quot;oops&quot;, &quot;around&quot;);
  eq(cm.getValue(), &quot;oopsbcd&quot;);
  cm.undo();
  eqPos(m.find().from, Pos(0, 1));
  eqPos(m.find().to, Pos(0, 4));
  m.clear();
  cm.setCursor(Pos(0, 2));
  cm.replaceSelection(&quot;hi&quot;, &quot;around&quot;);
  eq(cm.getLine(0), &quot;abhicde&quot;);
  eqPos(cm.getCursor(), Pos(0, 4));
  m = mark(0, 2, 2, 2, true);
  cm.setSelection(Pos(1, 1), Pos(2, 4));
  cm.replaceSelection(&quot;t&quot;, &quot;end&quot;);
  eqPos(cm.getCursor(), Pos(2, 3));
  eq(cm.getLine(2), &quot;klto&quot;);
  cm.execCommand(&quot;goCharLeft&quot;);
  cm.execCommand(&quot;goCharLeft&quot;);
  eqPos(cm.getCursor(), Pos(0, 2));
  cm.setSelection(Pos(0, 1), Pos(0, 3));
  cm.replaceSelection(&quot;xx&quot;, &quot;around&quot;);
  eqPos(cm.getCursor(), Pos(0, 3));
  eq(cm.getLine(0), &quot;axxhicde&quot;);
}, {value: &quot;abcde\nfghij\nklmno\n&quot;});

testCM(&quot;dirtyBit&quot;, function(cm) {
  eq(cm.isClean(), true);
  cm.replaceSelection(&quot;boo&quot;, null, &quot;test&quot;);
  eq(cm.isClean(), false);
  cm.undo();
  eq(cm.isClean(), true);
  cm.replaceSelection(&quot;boo&quot;, null, &quot;test&quot;);
  cm.replaceSelection(&quot;baz&quot;, null, &quot;test&quot;);
  cm.undo();
  eq(cm.isClean(), false);
  cm.markClean();
  eq(cm.isClean(), true);
  cm.undo();
  eq(cm.isClean(), false);
  cm.redo();
  eq(cm.isClean(), true);
});

testCM(&quot;changeGeneration&quot;, function(cm) {
  cm.replaceSelection(&quot;x&quot;);
  var softGen = cm.changeGeneration();
  cm.replaceSelection(&quot;x&quot;);
  cm.undo();
  eq(cm.getValue(), &quot;&quot;);
  is(!cm.isClean(softGen));
  cm.replaceSelection(&quot;x&quot;);
  var hardGen = cm.changeGeneration(true);
  cm.replaceSelection(&quot;x&quot;);
  cm.undo();
  eq(cm.getValue(), &quot;x&quot;);
  is(cm.isClean(hardGen));
});

testCM(&quot;addKeyMap&quot;, function(cm) {
  function sendKey(code) {
    cm.triggerOnKeyDown({type: &quot;keydown&quot;, keyCode: code,
                         preventDefault: function(){}, stopPropagation: function(){}});
  }

  sendKey(39);
  eqPos(cm.getCursor(), Pos(0, 1));
  var test = 0;
  var map1 = {Right: function() { ++test; }}, map2 = {Right: function() { test += 10; }}
  cm.addKeyMap(map1);
  sendKey(39);
  eqPos(cm.getCursor(), Pos(0, 1));
  eq(test, 1);
  cm.addKeyMap(map2, true);
  sendKey(39);
  eq(test, 2);
  cm.removeKeyMap(map1);
  sendKey(39);
  eq(test, 12);
  cm.removeKeyMap(map2);
  sendKey(39);
  eq(test, 12);
  eqPos(cm.getCursor(), Pos(0, 2));
  cm.addKeyMap({Right: function() { test = 55; }, name: &quot;mymap&quot;});
  sendKey(39);
  eq(test, 55);
  cm.removeKeyMap(&quot;mymap&quot;);
  sendKey(39);
  eqPos(cm.getCursor(), Pos(0, 3));
}, {value: &quot;abc&quot;});

testCM(&quot;findPosH&quot;, function(cm) {
  forEach([{from: Pos(0, 0), to: Pos(0, 1), by: 1},
           {from: Pos(0, 0), to: Pos(0, 0), by: -1, hitSide: true},
           {from: Pos(0, 0), to: Pos(0, 4), by: 1, unit: &quot;word&quot;},
           {from: Pos(0, 0), to: Pos(0, 8), by: 2, unit: &quot;word&quot;},
           {from: Pos(0, 0), to: Pos(2, 0), by: 20, unit: &quot;word&quot;, hitSide: true},
           {from: Pos(0, 7), to: Pos(0, 5), by: -1, unit: &quot;word&quot;},
           {from: Pos(0, 4), to: Pos(0, 8), by: 1, unit: &quot;word&quot;},
           {from: Pos(1, 0), to: Pos(1, 18), by: 3, unit: &quot;word&quot;},
           {from: Pos(1, 22), to: Pos(1, 5), by: -3, unit: &quot;word&quot;},
           {from: Pos(1, 15), to: Pos(1, 10), by: -5},
           {from: Pos(1, 15), to: Pos(1, 10), by: -5, unit: &quot;column&quot;},
           {from: Pos(1, 15), to: Pos(1, 0), by: -50, unit: &quot;column&quot;, hitSide: true},
           {from: Pos(1, 15), to: Pos(1, 24), by: 50, unit: &quot;column&quot;, hitSide: true},
           {from: Pos(1, 15), to: Pos(2, 0), by: 50, hitSide: true}], function(t) {
    var r = cm.findPosH(t.from, t.by, t.unit || &quot;char&quot;);
    eqPos(r, t.to);
    eq(!!r.hitSide, !!t.hitSide);
  });
}, {value: &quot;line one\nline two.something.other\n&quot;});

testCM(&quot;beforeChange&quot;, function(cm) {
  cm.on(&quot;beforeChange&quot;, function(cm, change) {
    var text = [];
    for (var i = 0; i &lt; change.text.length; ++i)
      text.push(change.text[i].replace(/\s/g, &quot;_&quot;));
    change.update(null, null, text);
  });
  cm.setValue(&quot;hello, i am a\nnew document\n&quot;);
  eq(cm.getValue(), &quot;hello,_i_am_a\nnew_document\n&quot;);
  CodeMirror.on(cm.getDoc(), &quot;beforeChange&quot;, function(doc, change) {
    if (change.from.line == 0) change.cancel();
  });
  cm.setValue(&quot;oops&quot;); // Canceled
  eq(cm.getValue(), &quot;hello,_i_am_a\nnew_document\n&quot;);
  cm.replaceRange(&quot;hey hey hey&quot;, Pos(1, 0), Pos(2, 0));
  eq(cm.getValue(), &quot;hello,_i_am_a\nhey_hey_hey&quot;);
}, {value: &quot;abcdefghijk&quot;});

testCM(&quot;beforeChangeUndo&quot;, function(cm) {
  cm.replaceRange(&quot;hi&quot;, Pos(0, 0), Pos(0));
  cm.replaceRange(&quot;bye&quot;, Pos(0, 0), Pos(0));
  eq(cm.historySize().undo, 2);
  cm.on(&quot;beforeChange&quot;, function(cm, change) {
    is(!change.update);
    change.cancel();
  });
  cm.undo();
  eq(cm.historySize().undo, 0);
  eq(cm.getValue(), &quot;bye\ntwo&quot;);
}, {value: &quot;one\ntwo&quot;});

testCM(&quot;beforeSelectionChange&quot;, function(cm) {
  function notAtEnd(cm, pos) {
    var len = cm.getLine(pos.line).length;
    if (!len || pos.ch == len) return Pos(pos.line, pos.ch - 1);
    return pos;
  }
  cm.on(&quot;beforeSelectionChange&quot;, function(cm, obj) {
    obj.update([{anchor: notAtEnd(cm, obj.ranges[0].anchor),
                 head: notAtEnd(cm, obj.ranges[0].head)}]);
  });

  addDoc(cm, 10, 10);
  cm.execCommand(&quot;goLineEnd&quot;);
  eqPos(cm.getCursor(), Pos(0, 9));
  cm.execCommand(&quot;selectAll&quot;);
  eqPos(cm.getCursor(&quot;start&quot;), Pos(0, 0));
  eqPos(cm.getCursor(&quot;end&quot;), Pos(9, 9));
});

testCM(&quot;change_removedText&quot;, function(cm) {
  cm.setValue(&quot;abc\ndef&quot;);

  var removedText = [];
  cm.on(&quot;change&quot;, function(cm, change) {
    removedText.push(change.removed);
  });

  cm.operation(function() {
    cm.replaceRange(&quot;xyz&quot;, Pos(0, 0), Pos(1,1));
    cm.replaceRange(&quot;123&quot;, Pos(0,0));
  });

  eq(removedText.length, 2);
  eq(removedText[0].join(&quot;\n&quot;), &quot;abc\nd&quot;);
  eq(removedText[1].join(&quot;\n&quot;), &quot;&quot;);

  var removedText = [];
  cm.undo();
  eq(removedText.length, 2);
  eq(removedText[0].join(&quot;\n&quot;), &quot;123&quot;);
  eq(removedText[1].join(&quot;\n&quot;), &quot;xyz&quot;);

  var removedText = [];
  cm.redo();
  eq(removedText.length, 2);
  eq(removedText[0].join(&quot;\n&quot;), &quot;abc\nd&quot;);
  eq(removedText[1].join(&quot;\n&quot;), &quot;&quot;);
});

testCM(&quot;lineStyleFromMode&quot;, function(cm) {
  CodeMirror.defineMode(&quot;test_mode&quot;, function() {
    return {token: function(stream) {
      if (stream.match(/^\[[^\]]*\]/)) return &quot;  line-brackets  &quot;;
      if (stream.match(/^\([^\)]*\)/)) return &quot;  line-background-parens  &quot;;
      if (stream.match(/^&lt;[^&gt;]*&gt;/)) return &quot;  span  line-line  line-background-bg  &quot;;
      stream.match(/^\s+|^\S+/);
    }};
  });
  cm.setOption(&quot;mode&quot;, &quot;test_mode&quot;);
  var bracketElts = byClassName(cm.getWrapperElement(), &quot;brackets&quot;);
  eq(bracketElts.length, 1, &quot;brackets count&quot;);
  eq(bracketElts[0].nodeName, &quot;PRE&quot;);
  is(!/brackets.*brackets/.test(bracketElts[0].className));
  var parenElts = byClassName(cm.getWrapperElement(), &quot;parens&quot;);
  eq(parenElts.length, 1, &quot;parens count&quot;);
  eq(parenElts[0].nodeName, &quot;DIV&quot;);
  is(!/parens.*parens/.test(parenElts[0].className));
  eq(parenElts[0].parentElement.nodeName, &quot;DIV&quot;);

  eq(byClassName(cm.getWrapperElement(), &quot;bg&quot;).length, 1);
  eq(byClassName(cm.getWrapperElement(), &quot;line&quot;).length, 1);
  var spanElts = byClassName(cm.getWrapperElement(), &quot;cm-span&quot;);
  eq(spanElts.length, 2);
  is(/^\s*cm-span\s*$/.test(spanElts[0].className));
}, {value: &quot;line1: [br] [br]\nline2: (par) (par)\nline3: &lt;tag&gt; &lt;tag&gt;&quot;});

testCM(&quot;lineStyleFromBlankLine&quot;, function(cm) {
  CodeMirror.defineMode(&quot;lineStyleFromBlankLine_mode&quot;, function() {
    return {token: function(stream) { stream.skipToEnd(); return &quot;comment&quot;; },
            blankLine: function() { return &quot;line-blank&quot;; }};
  });
  cm.setOption(&quot;mode&quot;, &quot;lineStyleFromBlankLine_mode&quot;);
  var blankElts = byClassName(cm.getWrapperElement(), &quot;blank&quot;);
  eq(blankElts.length, 1);
  eq(blankElts[0].nodeName, &quot;PRE&quot;);
  cm.replaceRange(&quot;x&quot;, Pos(1, 0));
  blankElts = byClassName(cm.getWrapperElement(), &quot;blank&quot;);
  eq(blankElts.length, 0);
}, {value: &quot;foo\n\nbar&quot;});

CodeMirror.registerHelper(&quot;xxx&quot;, &quot;a&quot;, &quot;A&quot;);
CodeMirror.registerHelper(&quot;xxx&quot;, &quot;b&quot;, &quot;B&quot;);
CodeMirror.defineMode(&quot;yyy&quot;, function() {
  return {
    token: function(stream) { stream.skipToEnd(); },
    xxx: [&quot;a&quot;, &quot;b&quot;, &quot;q&quot;]
  };
});
CodeMirror.registerGlobalHelper(&quot;xxx&quot;, &quot;c&quot;, function(m) { return m.enableC; }, &quot;C&quot;);

testCM(&quot;helpers&quot;, function(cm) {
  cm.setOption(&quot;mode&quot;, &quot;yyy&quot;);
  eq(cm.getHelpers(Pos(0, 0), &quot;xxx&quot;).join(&quot;/&quot;), &quot;A/B&quot;);
  cm.setOption(&quot;mode&quot;, {name: &quot;yyy&quot;, modeProps: {xxx: &quot;b&quot;, enableC: true}});
  eq(cm.getHelpers(Pos(0, 0), &quot;xxx&quot;).join(&quot;/&quot;), &quot;B/C&quot;);
  cm.setOption(&quot;mode&quot;, &quot;javascript&quot;);
  eq(cm.getHelpers(Pos(0, 0), &quot;xxx&quot;).join(&quot;/&quot;), &quot;&quot;);
});

testCM(&quot;selectionHistory&quot;, function(cm) {
  for (var i = 0; i &lt; 3; i++) {
    cm.setExtending(true);
    cm.execCommand(&quot;goCharRight&quot;);
    cm.setExtending(false);
    cm.execCommand(&quot;goCharRight&quot;);
    cm.execCommand(&quot;goCharRight&quot;);
  }
  cm.execCommand(&quot;undoSelection&quot;);
  eq(cm.getSelection(), &quot;c&quot;);
  cm.execCommand(&quot;undoSelection&quot;);
  eq(cm.getSelection(), &quot;&quot;);
  eqPos(cm.getCursor(), Pos(0, 4));
  cm.execCommand(&quot;undoSelection&quot;);
  eq(cm.getSelection(), &quot;b&quot;);
  cm.execCommand(&quot;redoSelection&quot;);
  eq(cm.getSelection(), &quot;&quot;);
  eqPos(cm.getCursor(), Pos(0, 4));
  cm.execCommand(&quot;redoSelection&quot;);
  eq(cm.getSelection(), &quot;c&quot;);
  cm.execCommand(&quot;redoSelection&quot;);
  eq(cm.getSelection(), &quot;&quot;);
  eqPos(cm.getCursor(), Pos(0, 6));
}, {value: &quot;a b c d&quot;});

testCM(&quot;selectionChangeReducesRedo&quot;, function(cm) {
  cm.replaceSelection(&quot;X&quot;);
  cm.execCommand(&quot;goCharRight&quot;);
  cm.undoSelection();
  cm.execCommand(&quot;selectAll&quot;);
  cm.undoSelection();
  eq(cm.getValue(), &quot;Xabc&quot;);
  eqPos(cm.getCursor(), Pos(0, 1));
  cm.undoSelection();
  eq(cm.getValue(), &quot;abc&quot;);
}, {value: &quot;abc&quot;});

testCM(&quot;selectionHistoryNonOverlapping&quot;, function(cm) {
  cm.setSelection(Pos(0, 0), Pos(0, 1));
  cm.setSelection(Pos(0, 2), Pos(0, 3));
  cm.execCommand(&quot;undoSelection&quot;);
  eqPos(cm.getCursor(&quot;anchor&quot;), Pos(0, 0));
  eqPos(cm.getCursor(&quot;head&quot;), Pos(0, 1));
}, {value: &quot;1234&quot;});

testCM(&quot;cursorMotionSplitsHistory&quot;, function(cm) {
  cm.replaceSelection(&quot;a&quot;);
  cm.execCommand(&quot;goCharRight&quot;);
  cm.replaceSelection(&quot;b&quot;);
  cm.replaceSelection(&quot;c&quot;);
  cm.undo();
  eq(cm.getValue(), &quot;a1234&quot;);
  eqPos(cm.getCursor(), Pos(0, 2));
  cm.undo();
  eq(cm.getValue(), &quot;1234&quot;);
  eqPos(cm.getCursor(), Pos(0, 0));
}, {value: &quot;1234&quot;});

testCM(&quot;selChangeInOperationDoesNotSplit&quot;, function(cm) {
  for (var i = 0; i &lt; 4; i++) {
    cm.operation(function() {
      cm.replaceSelection(&quot;x&quot;);
      cm.setCursor(Pos(0, cm.getCursor().ch - 1));
    });
  }
  eqPos(cm.getCursor(), Pos(0, 0));
  eq(cm.getValue(), &quot;xxxxa&quot;);
  cm.undo();
  eq(cm.getValue(), &quot;a&quot;);
}, {value: &quot;a&quot;});

testCM(&quot;alwaysMergeSelEventWithChangeOrigin&quot;, function(cm) {
  cm.replaceSelection(&quot;U&quot;, null, &quot;foo&quot;);
  cm.setSelection(Pos(0, 0), Pos(0, 1), {origin: &quot;foo&quot;});
  cm.undoSelection();
  eq(cm.getValue(), &quot;a&quot;);
  cm.replaceSelection(&quot;V&quot;, null, &quot;foo&quot;);
  cm.setSelection(Pos(0, 0), Pos(0, 1), {origin: &quot;bar&quot;});
  cm.undoSelection();
  eq(cm.getValue(), &quot;Va&quot;);
}, {value: &quot;a&quot;});

testCM(&quot;getTokenAt&quot;, function(cm) {
  var tokPlus = cm.getTokenAt(Pos(0, 2));
  eq(tokPlus.type, &quot;operator&quot;);
  eq(tokPlus.string, &quot;+&quot;);
  var toks = cm.getLineTokens(0);
  eq(toks.length, 3);
  forEach([[&quot;number&quot;, &quot;1&quot;], [&quot;operator&quot;, &quot;+&quot;], [&quot;number&quot;, &quot;2&quot;]], function(expect, i) {
    eq(toks[i].type, expect[0]);
    eq(toks[i].string, expect[1]);
  });
}, {value: &quot;1+2&quot;, mode: &quot;javascript&quot;});

testCM(&quot;getTokenTypeAt&quot;, function(cm) {
  eq(cm.getTokenTypeAt(Pos(0, 0)), &quot;number&quot;);
  eq(cm.getTokenTypeAt(Pos(0, 6)), &quot;string&quot;);
  cm.addOverlay({
    token: function(stream) {
      if (stream.match(&quot;foo&quot;)) return &quot;foo&quot;;
      else stream.next();
    }
  });
  eq(byClassName(cm.getWrapperElement(), &quot;cm-foo&quot;).length, 1);
  eq(cm.getTokenTypeAt(Pos(0, 6)), &quot;string&quot;);
}, {value: &quot;1 + &apos;foo&apos;&quot;, mode: &quot;javascript&quot;});

testCM(&quot;resizeLineWidget&quot;, function(cm) {
  addDoc(cm, 200, 3);
  var widget = document.createElement(&quot;pre&quot;);
  widget.innerHTML = &quot;imwidget&quot;;
  widget.style.background = &quot;yellow&quot;;
  cm.addLineWidget(1, widget, {noHScroll: true});
  cm.setSize(40);
  is(widget.parentNode.offsetWidth &lt; 42);
});

testCM(&quot;combinedOperations&quot;, function(cm) {
  var place = document.getElementById(&quot;testground&quot;);
  var other = CodeMirror(place, {value: &quot;123&quot;});
  try {
    cm.operation(function() {
      cm.addLineClass(0, &quot;wrap&quot;, &quot;foo&quot;);
      other.addLineClass(0, &quot;wrap&quot;, &quot;foo&quot;);
    });
    eq(byClassName(cm.getWrapperElement(), &quot;foo&quot;).length, 1);
    eq(byClassName(other.getWrapperElement(), &quot;foo&quot;).length, 1);
    cm.operation(function() {
      cm.removeLineClass(0, &quot;wrap&quot;, &quot;foo&quot;);
      other.removeLineClass(0, &quot;wrap&quot;, &quot;foo&quot;);
    });
    eq(byClassName(cm.getWrapperElement(), &quot;foo&quot;).length, 0);
    eq(byClassName(other.getWrapperElement(), &quot;foo&quot;).length, 0);
  } finally {
    place.removeChild(other.getWrapperElement());
  }
}, {value: &quot;abc&quot;});

testCM(&quot;eventOrder&quot;, function(cm) {
  var seen = [];
  cm.on(&quot;change&quot;, function() {
    if (!seen.length) cm.replaceSelection(&quot;.&quot;);
    seen.push(&quot;change&quot;);
  });
  cm.on(&quot;cursorActivity&quot;, function() {
    cm.replaceSelection(&quot;!&quot;);
    seen.push(&quot;activity&quot;);
  });
  cm.replaceSelection(&quot;/&quot;);
  eq(seen.join(&quot;,&quot;), &quot;change,change,activity,change&quot;);
});

testCM(&quot;splitSpaces_nonspecial&quot;, function(cm) {
  eq(byClassName(cm.getWrapperElement(), &quot;cm-invalidchar&quot;).length, 0);
}, {
  specialChars: /[\u00a0]/,
  value: &quot;spaces -&gt;            &lt;- between&quot;
});

test(&quot;core_rmClass&quot;, function() {
  var node = document.createElement(&quot;div&quot;);
  node.className = &quot;foo-bar baz-quux yadda&quot;;
  CodeMirror.rmClass(node, &quot;quux&quot;);
  eq(node.className, &quot;foo-bar baz-quux yadda&quot;);
  CodeMirror.rmClass(node, &quot;baz-quux&quot;);
  eq(node.className, &quot;foo-bar yadda&quot;);
  CodeMirror.rmClass(node, &quot;yadda&quot;);
  eq(node.className, &quot;foo-bar&quot;);
  CodeMirror.rmClass(node, &quot;foo-bar&quot;);
  eq(node.className, &quot;&quot;);
  node.className = &quot; foo &quot;;
  CodeMirror.rmClass(node, &quot;foo&quot;);
  eq(node.className, &quot;&quot;);
});

test(&quot;core_addClass&quot;, function() {
  var node = document.createElement(&quot;div&quot;);
  CodeMirror.addClass(node, &quot;a&quot;);
  eq(node.className, &quot;a&quot;);
  CodeMirror.addClass(node, &quot;a&quot;);
  eq(node.className, &quot;a&quot;);
  CodeMirror.addClass(node, &quot;b&quot;);
  eq(node.className, &quot;a b&quot;);
  CodeMirror.addClass(node, &quot;a&quot;);
  CodeMirror.addClass(node, &quot;b&quot;);
  eq(node.className, &quot;a b&quot;);
});

testCM(&quot;lineSeparator&quot;, function(cm) {
  eq(cm.lineCount(), 3);
  eq(cm.getLine(1), &quot;bar\r&quot;);
  eq(cm.getLine(2), &quot;baz\rquux&quot;);
  cm.setOption(&quot;lineSeparator&quot;, &quot;\r&quot;);
  eq(cm.lineCount(), 5);
  eq(cm.getLine(4), &quot;quux&quot;);
  eq(cm.getValue(), &quot;foo\rbar\r\rbaz\rquux&quot;);
  eq(cm.getValue(&quot;\n&quot;), &quot;foo\nbar\n\nbaz\nquux&quot;);
  cm.setOption(&quot;lineSeparator&quot;, null);
  cm.setValue(&quot;foo\nbar\r\nbaz\rquux&quot;);
  eq(cm.lineCount(), 4);
}, {value: &quot;foo\nbar\r\nbaz\rquux&quot;,
    lineSeparator: &quot;\n&quot;});
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
